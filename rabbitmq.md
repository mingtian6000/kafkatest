æˆ‘æ¥å¸®ä½ è¯»å– RabbitMQ å®˜æ–¹æ–‡æ¡£ï¼Œç„¶åä¸ºä½ åˆ¶å®šä¸€ä¸ªä» 3.x å‡çº§åˆ° 4.x çš„è¯¦ç»†æ–¹æ¡ˆã€‚

è®©æˆ‘æœç´¢ä¸€ä¸‹ RabbitMQ 3 åˆ° 4 å‡çº§çš„å®˜æ–¹æ–‡æ¡£å’Œæœ€ä½³å®è·µï¼š

åŸºäºæœç´¢åˆ°çš„å®˜æ–¹æ–‡æ¡£å’Œç¤¾åŒºæœ€ä½³å®è·µï¼Œæˆ‘ä¸ºä½ åˆ¶å®šäº†ä¸€ä»½è¯¦ç»†çš„ RabbitMQ 3.x â†’ 4.x ç”Ÿäº§ç¯å¢ƒå‡çº§æ–¹æ¡ˆã€‚

---

ğŸ¯ æ–¹æ¡ˆæ¦‚è¿°

RabbitMQ 4.x ç›¸æ¯” 3.x æœ‰é‡å¤§æ¶æ„å˜åŒ–ï¼ˆå¦‚å¼ºåˆ¶ Quorum Queuesã€ç§»é™¤ Classic Mirrored Queuesã€Erlang ç‰ˆæœ¬è¦æ±‚ç­‰ï¼‰ï¼Œå› æ­¤ä¸æ”¯æŒç›´æ¥ä» 3.9 æˆ–æ›´ä½ç‰ˆæœ¬å‡çº§åˆ° 4.xã€‚

æ¨èæ–¹æ¡ˆï¼šBlue-Green éƒ¨ç½²ï¼ˆé›¶åœæœºï¼‰

è¿™æ˜¯ç”Ÿäº§ç¯å¢ƒæœ€å®‰å…¨çš„é€‰æ‹©ï¼Œå¯ä»¥å®Œå…¨ä¿ç•™æ•°æ®å¹¶å®ç°æ— ç¼åˆ‡æ¢ã€‚

---

ğŸ“‹ å‰ç½®æ£€æŸ¥æ¸…å•

1. å½“å‰ç‰ˆæœ¬ç¡®è®¤

```bash
# æ£€æŸ¥å½“å‰ç‰ˆæœ¬
rabbitmqctl status | grep "RabbitMQ version"
# æˆ–
rabbitmq-diagnostics status
```

å‡çº§è·¯å¾„è¦æ±‚ï¼ˆå¿…é¡»ä¸¥æ ¼æ‰§è¡Œï¼‰ï¼š
- å¦‚æœå½“å‰æ˜¯ 3.9.xï¼š3.9 â†’ 3.10 â†’ 3.11 â†’ 3.12 â†’ 3.13.x â†’ 4.x
- å¦‚æœå½“å‰æ˜¯ 3.13.xï¼šå¯ä»¥ç›´æ¥å‡çº§åˆ° 4.x

2. å…³é”®å˜æ›´æ£€æŸ¥ï¼ˆ4.x ç ´åæ€§å˜æ›´ï¼‰
- Classic Mirrored Queues å·²ç§»é™¤ â†’ å¿…é¡»è¿ç§»åˆ° Quorum Queues
- Erlang ç‰ˆæœ¬è¦æ±‚ï¼šæœ€ä½ Erlang 25.0ï¼ˆæ¨è 26.x+ï¼‰
- å®¢æˆ·ç«¯å…¼å®¹æ€§ï¼šC# å®¢æˆ·ç«¯éœ€å‡çº§è‡³ 7.0+ï¼ŒJava å®¢æˆ·ç«¯éœ€ 5.18+
- ç‰¹æ€§æ ‡å¿—ï¼ˆFeature Flagsï¼‰ï¼š3.13 å¿…é¡»å¯ç”¨æ‰€æœ‰ç‰¹æ€§æ ‡å¿—æ‰èƒ½å‡çº§åˆ° 4.x

---

ğŸš€ æ¨èæ–¹æ¡ˆï¼šBlue-Green é›¶åœæœºå‡çº§

æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”Ÿäº§æµé‡                                 â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   ç”Ÿäº§è€…      â”‚â”€â”€â”€â”€â”€â–¶â”‚  Load        â”‚â”€â”€â”€â”€â”€â–¶â”‚   æ¶ˆè´¹è€…      â”‚   â”‚
â”‚  â”‚  (Producers) â”‚      â”‚  Balancer    â”‚      â”‚ (Consumers)   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                               â”‚                                  â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                    â”‚                     â”‚                       â”‚
â”‚                    â–¼                     â–¼                       â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚           â”‚  Blue é›†ç¾¤   â”‚â—„â”€â”€â”€â”€â–ºâ”‚  Green é›†ç¾¤  â”‚                  â”‚
â”‚           â”‚  (å½“å‰ 3.x)  â”‚      â”‚  (æ–° 4.x)   â”‚                  â”‚
â”‚           â”‚             â”‚      â”‚             â”‚                  â”‚
â”‚           â”‚ â€¢ ç°æœ‰æ•°æ®   â”‚      â”‚ â€¢ å…¨æ–°éƒ¨ç½²   â”‚                  â”‚
â”‚           â”‚ â€¢ é€æ­¥è¿ç§»   â”‚      â”‚ â€¢ åŒæ­¥æ•°æ®   â”‚                  â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                  â”‚                      â”‚                        â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                             â”‚                                    â”‚
â”‚                             â–¼                                    â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚                    â”‚  Federation â”‚  (é˜Ÿåˆ—è”é‚¦åŒæ­¥æ¶ˆæ¯)             â”‚
â”‚                    â”‚   Plugin    â”‚                               â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

è¯¦ç»†å®æ–½æ­¥éª¤

Phase 1: å‡†å¤‡é˜¶æ®µï¼ˆ1-2å¤©ï¼‰

1.1 éƒ¨ç½² Green é›†ç¾¤ï¼ˆRabbitMQ 4.xï¼‰

```bash
# åœ¨æ–°æœåŠ¡å™¨/K8s å‘½åç©ºé—´éƒ¨ç½² 4.x é›†ç¾¤
# ç¡®ä¿é…ç½®ä¸ Blue é›†ç¾¤ä¸€è‡´ï¼š
# - ç›¸åŒçš„ Erlang Cookie
# - ç›¸åŒçš„ç”¨æˆ·/å¯†ç 
# - ç›¸åŒçš„ vhost ç»“æ„
```

1.2 å¯¼å‡º Blue é›†ç¾¤é…ç½®

```bash
# ä½¿ç”¨ rabbitmqadmin v2 å¯¼å‡ºå®šä¹‰ï¼ˆé˜Ÿåˆ—ã€äº¤æ¢æœºã€ç»‘å®šã€ç”¨æˆ·ç­‰ï¼‰
rabbitmqadmin export definitions.json

# æˆ–ä½¿ç”¨ HTTP API
curl -u user:password http://blue-cluster:15672/api/definitions > definitions.json
```

1.3 å¯¼å…¥åˆ° Green é›†ç¾¤

```bash
rabbitmqadmin -H green-cluster import definitions.json
```

1.4 å¯ç”¨ Federation æ’ä»¶ï¼ˆå…³é”®æ­¥éª¤ï¼‰

```bash
# åœ¨ Green é›†ç¾¤ï¼ˆ4.xï¼‰ä¸Šæ‰§è¡Œ
rabbitmq-plugins enable rabbitmq_federation rabbitmq_federation_management

# é…ç½® Federation Upstreamï¼ˆæŒ‡å‘ Blue é›†ç¾¤ï¼‰
rabbitmqctl set_parameter federation-upstream blue_cluster_upstream \
  '{"uri": "amqp://user:password@blue-node1:5672,amqp://user:password@blue-node2:5672"}'

# åˆ›å»º Policy è‡ªåŠ¨åŒæ­¥æ‰€æœ‰é˜Ÿåˆ—
rabbitmqctl set_policy --apply-to queues blue-green-migration ".*" \
  '{"federation-upstream":"blue_cluster_upstream"}' --priority 1
```

Phase 2: æ•°æ®åŒæ­¥é˜¶æ®µï¼ˆ1-7å¤©ï¼Œè§†æ•°æ®é‡ï¼‰

2.1 ç›‘æ§åŒæ­¥çŠ¶æ€

```bash
# æŸ¥çœ‹ Federation çŠ¶æ€
rabbitmqctl federation_status

# ç¡®ä¿é˜Ÿåˆ—æ¶ˆæ¯åŒæ­¥å®Œæˆ
rabbitmqctl list_queues name messages_ready messages_unacknowledged
```

2.2 éªŒè¯ Green é›†ç¾¤å¥åº·
- æ£€æŸ¥ 4.x ç‰¹æ€§æ ‡å¿—æ˜¯å¦å…¨éƒ¨å¯ç”¨
- éªŒè¯ Quorum Queues æ­£å¸¸å·¥ä½œï¼ˆå¦‚é€‚ç”¨ï¼‰
- æµ‹è¯•å®¢æˆ·ç«¯è¿æ¥

Phase 3: æµé‡åˆ‡æ¢é˜¶æ®µï¼ˆåˆ†é’Ÿçº§åœæœºï¼‰

3.1 ç”Ÿäº§è€…åˆ‡æ¢ï¼ˆå…ˆåˆ‡ç”Ÿäº§è€…ï¼‰

```bash
# æ›´æ–° DNS æˆ–é…ç½®ä¸­å¿ƒï¼Œå°†ç”Ÿäº§è€…æŒ‡å‘ Green é›†ç¾¤
# ä½¿ç”¨è“ç»¿å‘å¸ƒæˆ–é…ç½®ä¸­å¿ƒçƒ­æ›´æ–°
```

3.2 ç­‰å¾… Blue é˜Ÿåˆ—æ¶ˆè´¹å®Œæ¯•

```bash
# ç›‘æ§ Blue é›†ç¾¤é˜Ÿåˆ—æ·±åº¦
watch 'rabbitmqctl list_queues name messages_ready'

# ç›´åˆ°æ‰€æœ‰é˜Ÿåˆ—ä¸ºç©º
```

3.3 æ¶ˆè´¹è€…åˆ‡æ¢

```bash
# å°†æ¶ˆè´¹è€…åˆ‡æ¢åˆ° Green é›†ç¾¤
# æ­¤æ—¶ä¸šåŠ¡å®Œå…¨è¿è¡Œåœ¨ 4.x ä¸Š
```

3.4 ä¿ç•™ Blue é›†ç¾¤ï¼ˆå›æ»šä¿é™©ï¼‰

```bash
# ä¿æŒ Blue é›†ç¾¤è¿è¡Œ 24-72 å°æ—¶
# å¦‚é‡é—®é¢˜å¯ç«‹å³åˆ‡å›
```

Phase 4: æ¸…ç†é˜¶æ®µ

4.1 ç¡®è®¤ç¨³å®šåä¸‹çº¿ Blue

```bash
# åœæ­¢ Federation
rabbitmqctl clear_policy blue-green-migration
rabbitmqctl clear_parameter federation-upstream blue_cluster_upstream

# ä¼˜é›…å…³é—­ Blue é›†ç¾¤
rabbitmqctl stop
```

---

âš¡ å¤‡é€‰æ–¹æ¡ˆï¼šæ»šåŠ¨å‡çº§ï¼ˆå¦‚æœå¿…é¡»ä½¿ç”¨åŒä¸€é›†ç¾¤ï¼‰

âš ï¸ è­¦å‘Šï¼šæ­¤æ–¹æ¡ˆæœ‰åˆ†é’Ÿçº§åœæœºï¼Œä»…é€‚ç”¨äº 3.13.x â†’ 4.x

å‡çº§è·¯å¾„

```bash
# å‡è®¾å½“å‰æ˜¯ 3.13.7
# 1. å…ˆå‡çº§åˆ°æœ€æ–°çš„ 3.13.x
apt-get install rabbitmq-server=3.13.7-1

# 2. å¯ç”¨æ‰€æœ‰ç‰¹æ€§æ ‡å¿—ï¼ˆå…³é”®ï¼ï¼‰
rabbitmqctl enable_feature_flag all

# 3. é€ä¸ªèŠ‚ç‚¹å‡çº§åˆ° 4.0.x
# èŠ‚ç‚¹1
rabbitmqctl stop_app
# å‡çº§åŒ…
apt-get install rabbitmq-server=4.0.8-1
rabbitmqctl start_app

# ç­‰å¾…é›†ç¾¤åŒæ­¥ï¼Œç„¶åå‡çº§èŠ‚ç‚¹2ã€3...
```

é£é™©ç‚¹
- å‡çº§æœŸé—´é›†ç¾¤å¤„äºæ··åˆç‰ˆæœ¬çŠ¶æ€ï¼Œéƒ¨åˆ†åŠŸèƒ½å—é™
- å¿…é¡»ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹è¿è¡Œç›¸åŒ Erlang ç‰ˆæœ¬
- Classic Mirrored Queues éœ€è¦æå‰è¿ç§»åˆ° Quorum Queues

---

ğŸ”§ å…³é”®æ“ä½œå‘½ä»¤æ±‡æ€»

æ“ä½œ	å‘½ä»¤	
æ£€æŸ¥ç‰ˆæœ¬	`rabbitmqctl status \| grep "RabbitMQ versi

