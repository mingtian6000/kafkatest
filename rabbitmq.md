æˆ‘æ¥å¸®ä½ è¯»å– RabbitMQ å®˜æ–¹æ–‡æ¡£ï¼Œç„¶åä¸ºä½ åˆ¶å®šä¸€ä¸ªä» 3.x å‡çº§åˆ° 4.x çš„è¯¦ç»†æ–¹æ¡ˆã€‚

è®©æˆ‘æœç´¢ä¸€ä¸‹ RabbitMQ 3 åˆ° 4 å‡çº§çš„å®˜æ–¹æ–‡æ¡£å’Œæœ€ä½³å®è·µï¼š

åŸºäºæœç´¢åˆ°çš„å®˜æ–¹æ–‡æ¡£å’Œç¤¾åŒºæœ€ä½³å®è·µï¼Œæˆ‘ä¸ºä½ åˆ¶å®šäº†ä¸€ä»½è¯¦ç»†çš„ RabbitMQ 3.x â†’ 4.x ç”Ÿäº§ç¯å¢ƒå‡çº§æ–¹æ¡ˆã€‚

---

ğŸ¯ æ–¹æ¡ˆæ¦‚è¿°

RabbitMQ 4.x ç›¸æ¯” 3.x æœ‰é‡å¤§æ¶æ„å˜åŒ–ï¼ˆå¦‚å¼ºåˆ¶ Quorum Queuesã€ç§»é™¤ Classic Mirrored Queuesã€Erlang ç‰ˆæœ¬è¦æ±‚ç­‰ï¼‰ï¼Œå› æ­¤ä¸æ”¯æŒç›´æ¥ä» 3.9 æˆ–æ›´ä½ç‰ˆæœ¬å‡çº§åˆ° 4.xã€‚

æ¨èæ–¹æ¡ˆï¼šBlue-Green éƒ¨ç½²ï¼ˆé›¶åœæœºï¼‰

è¿™æ˜¯ç”Ÿäº§ç¯å¢ƒæœ€å®‰å…¨çš„é€‰æ‹©ï¼Œå¯ä»¥å®Œå…¨ä¿ç•™æ•°æ®å¹¶å®ç°æ— ç¼åˆ‡æ¢ã€‚

è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é—®é¢˜ï¼è®©æˆ‘æœç´¢ä¸€ä¸‹ RabbitMQ å®˜æ–¹å…³äºç‰ˆæœ¬å‡çº§è·¯å¾„çš„å…·ä½“è§£é‡Šï¼š

å¤ªå¥½äº†ï¼Œæˆ‘æ‰¾åˆ°äº†å®˜æ–¹è§£é‡Šï¼è®©æˆ‘ä¸ºä½ è¯¦ç»†è§£é‡Šä¸ºä»€ä¹ˆå¿…é¡»ä» 3.13 æ‰èƒ½å‡çº§åˆ° 4.xï¼Œè€Œä¸èƒ½ä» 3.11 ç›´æ¥è·³è¿‡å»ã€‚

---

ğŸ” æ ¸å¿ƒåŸå› ï¼šç‰¹æ€§æ ‡å¿—ï¼ˆFeature Flagsï¼‰æœºåˆ¶

RabbitMQ ä» 3.8 å¼€å§‹å¼•å…¥ Feature Flags æœºåˆ¶ï¼Œè¿™æ˜¯ä¸ºäº†å…è®¸é›†ç¾¤åœ¨ä¸ä¸­æ–­æœåŠ¡çš„æƒ…å†µä¸‹é€æ­¥å¯ç”¨æ–°åŠŸèƒ½ã€‚ä½†è¿™ä¹Ÿå¯¼è‡´äº†ç‰ˆæœ¬å‡çº§çš„ç¡¬æ€§ä¾èµ–é“¾ã€‚

å®˜æ–¹æ˜ç¡®å£°æ˜ï¼š

> "This release series only supports upgrades from `3.13.x`. This release requires all feature flags in the 3.x series (specifically `3.13.x`) to be enabled before upgrading, there is no upgrade path from 3.12.14 (or a later patch release) straight to `4.0.0`."

"You can only upgrade to RabbitMQ 4.0 from RabbitMQ 3.13.x. Don't forget to enable all stable feature flags while still on 3.13, before attempting an upgrade to RabbitMQ 4.0, or the upgrade will fail."

---

ğŸ§© ä¸ºä»€ä¹ˆä¸èƒ½è·³è¿‡ 3.12 â†’ 3.13 ç›´æ¥åˆ° 4.0ï¼Ÿ

1. ç‰¹æ€§æ ‡å¿—çš„ç´¯ç§¯ä¾èµ–

æ¯ä¸ªæ¬¡è¦ç‰ˆæœ¬ï¼ˆ3.11ã€3.12ã€3.13ï¼‰éƒ½ä¼šå¼•å…¥æ–°çš„ç‰¹æ€§æ ‡å¿—ï¼Œè€Œè¿™äº›æ ‡å¿—åœ¨åç»­ç‰ˆæœ¬ä¸­ä¼šå˜æˆå¿…éœ€ï¼ˆRequiredï¼‰ï¼š

ç‰ˆæœ¬	å¼•å…¥çš„æ–°ç‰¹æ€§æ ‡å¿—ï¼ˆéƒ¨åˆ†å…³é”®ï¼‰	åˆ°ä¸‹ä¸€ç‰ˆæœ¬çš„è¦æ±‚	
3.11	`classic_mirrored_queue_version`, `quorum_queue` ç­‰	3.12 è¦æ±‚è¿™äº›å¿…é¡»å¯ç”¨	
3.12	`stream_filtering`, `stream_queue_coordinator_procs` ç­‰	3.13 è¦æ±‚è¿™äº›å¿…é¡»å¯ç”¨	
3.13	`detailed_queues_endpoint`, `message_containers`, `stream_update_config_command` ç­‰	4.0 è¦æ±‚è¿™äº›å¿…é¡»å¯ç”¨	

å…³é”®é—®é¢˜ï¼š3.11 æ ¹æœ¬ä¸çŸ¥é“ 3.13 å’Œ 4.0 éœ€è¦å“ªäº›ç‰¹æ€§æ ‡å¿—ï¼

çœ‹ä¸€ä¸ªçœŸå®æ¡ˆä¾‹ï¼š
- ç”¨æˆ·ä» 3.12.10 ç›´æ¥å‡çº§åˆ° 4.0.5
- æŠ¥é”™ï¼š`Feature flags: 'stream_filtering': required feature flag not enabled!`
- å›æ»šåˆ° 3.12.10 åå‘ç°æ ¹æœ¬æ²¡æœ‰ `stream_filtering` è¿™ä¸ªæ ‡å¿—ï¼
- å› ä¸ºè¿™ä¸ªæ ‡å¿—æ˜¯åœ¨ 3.13 æ‰å¼•å…¥çš„ï¼Œ3.12 æ— æ³•å¯ç”¨ä¸€ä¸ªä¸å­˜åœ¨çš„æ ‡å¿—

2. Schema æ•°æ®åº“ï¼ˆMnesia/Khepriï¼‰çš„å…ƒæ•°æ®æ ¼å¼å˜æ›´

RabbitMQ ä½¿ç”¨ Mnesiaï¼ˆ3.x é»˜è®¤ï¼‰æˆ– Khepriï¼ˆ4.x å¯é€‰ï¼‰å­˜å‚¨å…ƒæ•°æ®ã€‚æ¯æ¬¡ç‰ˆæœ¬å‡çº§éƒ½å¯èƒ½æ¶‰åŠï¼š

- å†…éƒ¨è¡¨ç»“æ„å˜æ›´ï¼ˆå¦‚é˜Ÿåˆ—å…ƒæ•°æ®ã€ç»‘å®šä¿¡æ¯å­˜å‚¨æ ¼å¼ï¼‰
- Erlang æœ¯è¯­ï¼ˆTermï¼‰æ ¼å¼çš„å…¼å®¹æ€§
- é›†ç¾¤çŠ¶æ€æœºçš„åè®®å˜æ›´

3.13 æ˜¯ 3.x ç³»åˆ—çš„æœ€åä¸€ä¸ªç‰ˆæœ¬ï¼Œå®ƒåŒ…å«äº†æ‰€æœ‰ 3.x æ—¶ä»£çš„å…ƒæ•°æ®è¿ç§»é€»è¾‘ã€‚4.0 åªä¿ç•™äº†ä» 3.13 æ ¼å¼è¿ç§»åˆ° 4.0 æ ¼å¼çš„é€»è¾‘ï¼Œæ²¡æœ‰ä¿ç•™ä» 3.11 æˆ– 3.12 è¿ç§»çš„é€»è¾‘ã€‚

3. Khepri å…ƒæ•°æ®å­˜å‚¨çš„é‡å¤§å˜æ›´

RabbitMQ åœ¨ 3.13 å®éªŒæ€§å¼•å…¥äº† Khepri ä½œä¸º Mnesia çš„æ›¿ä»£ï¼š
- 3.13 çš„ Khepri å®ç°ä¸ 4.0 çš„ Khepri ä¸å…¼å®¹
- å¦‚æœåœ¨ 3.13 å¯ç”¨äº† `khepri_db` ç‰¹æ€§æ ‡å¿—ï¼Œåè€Œä¸èƒ½å‡çº§åˆ° 4.0
- 4.0 çš„ Khepri æ˜¯ç¨³å®šç‰ˆï¼Œå†…éƒ¨å®ç°æœ‰é‡å¤§å˜æ›´

è¿™è¿›ä¸€æ­¥è¯æ˜äº† 3.13 æ˜¯ä¸€ä¸ª"è½¬æ¢å«"ç‰ˆæœ¬ï¼Œè´Ÿè´£å¤„ç†æ‰€æœ‰ 3.x åˆ° 4.x çš„è¿‡æ¸¡é€»è¾‘ã€‚

---

ğŸ›¡ï¸ ä¸ºä»€ä¹ˆ Blue-Green å¯ä»¥è·³è¿‡ä¸­é—´ç‰ˆæœ¬ï¼Ÿ

ä½ ä»¬è®¡åˆ’ç”¨ Blue-Green å‡çº§ï¼Œè¿™ç¡®å®æ˜¯å”¯ä¸€å¯ä»¥è·³è¿‡ä¸­é—´ç‰ˆæœ¬çš„æ–¹æ³•ï¼š

> "Alternatively, instead of a series of upgrades, you can use a Blue/Green upgrade and move directly to `4.0.x` that way. It is more involved but works even for multi-minor gaps, e.g. 3.8.x => 4.0.x upgrades."

åŸå› ï¼š
- Blue-Green æ˜¯è¿ç§»ï¼ˆMigrationï¼‰è€Œéå‡çº§ï¼ˆUpgradeï¼‰
- ä½ åœ¨ Green é›†ç¾¤ï¼ˆ4.xï¼‰æ˜¯å…¨æ–°éƒ¨ç½²ï¼Œä¸ç»§æ‰¿ Blue é›†ç¾¤ï¼ˆ3.xï¼‰çš„å…ƒæ•°æ®çŠ¶æ€
- é€šè¿‡ Federation/Shovel åŒæ­¥çš„æ˜¯æ¶ˆæ¯æ•°æ®ï¼Œè€Œéé›†ç¾¤å…ƒæ•°æ®
- 4.x åªéœ€è¦å¤„ç†æ¶ˆæ¯æ ¼å¼ï¼Œè€Œæ¶ˆæ¯æ ¼å¼ï¼ˆAMQP 0-9-1/1.0ï¼‰åœ¨ 3.x å’Œ 4.x ä¹‹é—´æ˜¯å…¼å®¹çš„

---

ğŸ“‹ å…·ä½“åˆ°ä½ çš„æƒ…å†µï¼ˆ3.11 â†’ 4.xï¼‰

å¦‚æœé€‰æ‹©åŸåœ°æ»šåŠ¨å‡çº§ï¼ˆä¸æ¨èï¼‰ï¼š

```
3.11.9 â†’ 3.11.18 â†’ 3.12.x â†’ 3.13.x â†’ 4.0.x
```

æ¯ä¸ªç®­å¤´éƒ½æ˜¯ä¸€æ¬¡é›†ç¾¤é‡å¯+å…ƒæ•°æ®è¿ç§»ï¼Œç”Ÿäº§ç¯å¢ƒé£é™©æé«˜ã€‚

å¦‚æœé€‰æ‹©Blue-Greenï¼ˆæ¨èï¼‰ï¼š

```
3.11.x (Blue) â”€â”€Federation/Shovelâ”€â”€â–º 4.0.x (Green)
         \                          /
          \_____ ç›´æ¥åˆ‡æ¢æµé‡ _______/
```

è·³è¿‡æ‰€æœ‰ä¸­é—´ç‰ˆæœ¬ï¼Œå› ä¸º Green æ˜¯å…¨æ–°é›†ç¾¤ï¼Œæ²¡æœ‰å†å²åŒ…è¢±ã€‚

---

âš ï¸ é‡è¦æé†’

å³ä½¿ä½¿ç”¨ Blue-Greenï¼Œä¹Ÿè¦æ³¨æ„ï¼š

1. å®¢æˆ·ç«¯å…¼å®¹æ€§ï¼šç¡®ä¿ç”Ÿäº§è€…/æ¶ˆè´¹è€…å®¢æˆ·ç«¯æ”¯æŒ 4.xï¼ˆå¦‚ C# å®¢æˆ·ç«¯éœ€ 7.0+ï¼‰
2. é˜Ÿåˆ—ç±»å‹ï¼š3.11 çš„ Classic Mirrored Queues åœ¨ 4.x å·²ç§»é™¤ï¼Œéœ€è¦æå‰è¿ç§»åˆ° Quorum Queues
3. Erlang ç‰ˆæœ¬ï¼š4.x è¦æ±‚ Erlang 26.2+ï¼Œä¸ 3.11 å¯èƒ½ä¸å…¼å®¹
4. é…ç½®å˜æ›´ï¼š4.x æœ‰ä¸€äº›é…ç½®é¡¹å˜åŒ–ï¼ˆå¦‚ MQTT é»˜è®¤ç”¨æˆ·é…ç½®ï¼‰

---

ğŸ¯ æ€»ç»“

é—®é¢˜	ç­”æ¡ˆ	
ä¸ºä»€ä¹ˆä¸èƒ½ 3.11 â†’ 4.0ï¼Ÿ	3.11 ç¼ºå°‘ 3.12/3.13 å¼•å…¥çš„ç‰¹æ€§æ ‡å¿—ï¼Œæ— æ³•å¯ç”¨ 4.0 æ‰€éœ€çš„æ ‡å¿—	
ä¸ºä»€ä¹ˆå¿…é¡» 3.13 æ‰èƒ½åˆ° 4.0ï¼Ÿ	3.13 æ˜¯ 3.x æœ€åä¸€ä¸ªç‰ˆæœ¬ï¼ŒåŒ…å«æ‰€æœ‰åˆ° 4.x çš„è¿ç§»é€»è¾‘	
Blue-Green ä¸ºä»€ä¹ˆå¯ä»¥è·³è¿‡ï¼Ÿ	å› ä¸ºæ˜¯æ–°å»ºé›†ç¾¤ï¼Œä¸æ¶‰åŠå…ƒæ•°æ®è¿ç§»ï¼ŒåªåŒæ­¥æ¶ˆæ¯	
ç”Ÿäº§ç¯å¢ƒæ¨èï¼Ÿ	Blue-Greenï¼Œé›¶åœæœºã€å¯å›æ»šã€è·³è¿‡ä¸­é—´ç‰ˆæœ¬	

ä½ ä»¬çš„ Blue-Green æ–¹æ¡ˆæ˜¯æœ€æ˜æ™ºçš„é€‰æ‹©ï¼Œæ—¢é¿å…äº†å¤æ‚çš„é˜¶æ¢¯å‡çº§ï¼Œåˆä¿è¯äº†ç”Ÿäº§ç¨³å®šæ€§ã€‚

---

ğŸ“‹ å‰ç½®æ£€æŸ¥æ¸…å•

1. å½“å‰ç‰ˆæœ¬ç¡®è®¤

```bash
# æ£€æŸ¥å½“å‰ç‰ˆæœ¬
rabbitmqctl status | grep "RabbitMQ version"
# æˆ–
rabbitmq-diagnostics status
```

å‡çº§è·¯å¾„è¦æ±‚ï¼ˆå¿…é¡»ä¸¥æ ¼æ‰§è¡Œï¼‰ï¼š
- å¦‚æœå½“å‰æ˜¯ 3.9.xï¼š3.9 â†’ 3.10 â†’ 3.11 â†’ 3.12 â†’ 3.13.x â†’ 4.x
- å¦‚æœå½“å‰æ˜¯ 3.13.xï¼šå¯ä»¥ç›´æ¥å‡çº§åˆ° 4.x

2. å…³é”®å˜æ›´æ£€æŸ¥ï¼ˆ4.x ç ´åæ€§å˜æ›´ï¼‰
- Classic Mirrored Queues å·²ç§»é™¤ â†’ å¿…é¡»è¿ç§»åˆ° Quorum Queues
- Erlang ç‰ˆæœ¬è¦æ±‚ï¼šæœ€ä½ Erlang 25.0ï¼ˆæ¨è 26.x+ï¼‰
- å®¢æˆ·ç«¯å…¼å®¹æ€§ï¼šC# å®¢æˆ·ç«¯éœ€å‡çº§è‡³ 7.0+ï¼ŒJava å®¢æˆ·ç«¯éœ€ 5.18+
- ç‰¹æ€§æ ‡å¿—ï¼ˆFeature Flagsï¼‰ï¼š3.13 å¿…é¡»å¯ç”¨æ‰€æœ‰ç‰¹æ€§æ ‡å¿—æ‰èƒ½å‡çº§åˆ° 4.x

---

ğŸš€ æ¨èæ–¹æ¡ˆï¼šBlue-Green é›¶åœæœºå‡çº§

æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”Ÿäº§æµé‡                                 â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   ç”Ÿäº§è€…      â”‚â”€â”€â”€â”€â”€â–¶â”‚  Load        â”‚â”€â”€â”€â”€â”€â–¶â”‚   æ¶ˆè´¹è€…      â”‚   â”‚
â”‚  â”‚  (Producers) â”‚      â”‚  Balancer    â”‚      â”‚ (Consumers)   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                               â”‚                                  â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                    â”‚                     â”‚                       â”‚
â”‚                    â–¼                     â–¼                       â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚           â”‚  Blue é›†ç¾¤   â”‚â—„â”€â”€â”€â”€â–ºâ”‚  Green é›†ç¾¤  â”‚                  â”‚
â”‚           â”‚  (å½“å‰ 3.x)  â”‚      â”‚  (æ–° 4.x)   â”‚                  â”‚
â”‚           â”‚             â”‚      â”‚             â”‚                  â”‚
â”‚           â”‚ â€¢ ç°æœ‰æ•°æ®   â”‚      â”‚ â€¢ å…¨æ–°éƒ¨ç½²   â”‚                  â”‚
â”‚           â”‚ â€¢ é€æ­¥è¿ç§»   â”‚      â”‚ â€¢ åŒæ­¥æ•°æ®   â”‚                  â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                  â”‚                      â”‚                        â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                             â”‚                                    â”‚
â”‚                             â–¼                                    â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚                    â”‚  Federation â”‚  (é˜Ÿåˆ—è”é‚¦åŒæ­¥æ¶ˆæ¯)             â”‚
â”‚                    â”‚   Plugin    â”‚                               â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

è¯¦ç»†å®æ–½æ­¥éª¤

Phase 1: å‡†å¤‡é˜¶æ®µï¼ˆ1-2å¤©ï¼‰

1.1 éƒ¨ç½² Green é›†ç¾¤ï¼ˆRabbitMQ 4.xï¼‰

```bash
# åœ¨æ–°æœåŠ¡å™¨/K8s å‘½åç©ºé—´éƒ¨ç½² 4.x é›†ç¾¤
# ç¡®ä¿é…ç½®ä¸ Blue é›†ç¾¤ä¸€è‡´ï¼š
# - ç›¸åŒçš„ Erlang Cookie
# - ç›¸åŒçš„ç”¨æˆ·/å¯†ç 
# - ç›¸åŒçš„ vhost ç»“æ„
```

1.2 å¯¼å‡º Blue é›†ç¾¤é…ç½®

```bash
# ä½¿ç”¨ rabbitmqadmin v2 å¯¼å‡ºå®šä¹‰ï¼ˆé˜Ÿåˆ—ã€äº¤æ¢æœºã€ç»‘å®šã€ç”¨æˆ·ç­‰ï¼‰
rabbitmqadmin export definitions.json

# æˆ–ä½¿ç”¨ HTTP API
curl -u user:password http://blue-cluster:15672/api/definitions > definitions.json
```

1.3 å¯¼å…¥åˆ° Green é›†ç¾¤

```bash
rabbitmqadmin -H green-cluster import definitions.json
```

1.4 å¯ç”¨ Federation æ’ä»¶ï¼ˆå…³é”®æ­¥éª¤ï¼‰

```bash
# åœ¨ Green é›†ç¾¤ï¼ˆ4.xï¼‰ä¸Šæ‰§è¡Œ
rabbitmq-plugins enable rabbitmq_federation rabbitmq_federation_management

# é…ç½® Federation Upstreamï¼ˆæŒ‡å‘ Blue é›†ç¾¤ï¼‰
rabbitmqctl set_parameter federation-upstream blue_cluster_upstream \
  '{"uri": "amqp://user:password@blue-node1:5672,amqp://user:password@blue-node2:5672"}'

# åˆ›å»º Policy è‡ªåŠ¨åŒæ­¥æ‰€æœ‰é˜Ÿåˆ—
rabbitmqctl set_policy --apply-to queues blue-green-migration ".*" \
  '{"federation-upstream":"blue_cluster_upstream"}' --priority 1
```

Phase 2: æ•°æ®åŒæ­¥é˜¶æ®µï¼ˆ1-7å¤©ï¼Œè§†æ•°æ®é‡ï¼‰

2.1 ç›‘æ§åŒæ­¥çŠ¶æ€

```bash
# æŸ¥çœ‹ Federation çŠ¶æ€
rabbitmqctl federation_status

# ç¡®ä¿é˜Ÿåˆ—æ¶ˆæ¯åŒæ­¥å®Œæˆ
rabbitmqctl list_queues name messages_ready messages_unacknowledged
```

2.2 éªŒè¯ Green é›†ç¾¤å¥åº·
- æ£€æŸ¥ 4.x ç‰¹æ€§æ ‡å¿—æ˜¯å¦å…¨éƒ¨å¯ç”¨
- éªŒè¯ Quorum Queues æ­£å¸¸å·¥ä½œï¼ˆå¦‚é€‚ç”¨ï¼‰
- æµ‹è¯•å®¢æˆ·ç«¯è¿æ¥

Phase 3: æµé‡åˆ‡æ¢é˜¶æ®µï¼ˆåˆ†é’Ÿçº§åœæœºï¼‰

3.1 ç”Ÿäº§è€…åˆ‡æ¢ï¼ˆå…ˆåˆ‡ç”Ÿäº§è€…ï¼‰

```bash
# æ›´æ–° DNS æˆ–é…ç½®ä¸­å¿ƒï¼Œå°†ç”Ÿäº§è€…æŒ‡å‘ Green é›†ç¾¤
# ä½¿ç”¨è“ç»¿å‘å¸ƒæˆ–é…ç½®ä¸­å¿ƒçƒ­æ›´æ–°
```

3.2 ç­‰å¾… Blue é˜Ÿåˆ—æ¶ˆè´¹å®Œæ¯•

```bash
# ç›‘æ§ Blue é›†ç¾¤é˜Ÿåˆ—æ·±åº¦
watch 'rabbitmqctl list_queues name messages_ready'

# ç›´åˆ°æ‰€æœ‰é˜Ÿåˆ—ä¸ºç©º
```

3.3 æ¶ˆè´¹è€…åˆ‡æ¢

```bash
# å°†æ¶ˆè´¹è€…åˆ‡æ¢åˆ° Green é›†ç¾¤
# æ­¤æ—¶ä¸šåŠ¡å®Œå…¨è¿è¡Œåœ¨ 4.x ä¸Š
```

3.4 ä¿ç•™ Blue é›†ç¾¤ï¼ˆå›æ»šä¿é™©ï¼‰

```bash
# ä¿æŒ Blue é›†ç¾¤è¿è¡Œ 24-72 å°æ—¶
# å¦‚é‡é—®é¢˜å¯ç«‹å³åˆ‡å›
```

Phase 4: æ¸…ç†é˜¶æ®µ

4.1 ç¡®è®¤ç¨³å®šåä¸‹çº¿ Blue

```bash
# åœæ­¢ Federation
rabbitmqctl clear_policy blue-green-migration
rabbitmqctl clear_parameter federation-upstream blue_cluster_upstream

# ä¼˜é›…å…³é—­ Blue é›†ç¾¤
rabbitmqctl stop
```

---

âš¡ å¤‡é€‰æ–¹æ¡ˆï¼šæ»šåŠ¨å‡çº§ï¼ˆå¦‚æœå¿…é¡»ä½¿ç”¨åŒä¸€é›†ç¾¤ï¼‰

âš ï¸ è­¦å‘Šï¼šæ­¤æ–¹æ¡ˆæœ‰åˆ†é’Ÿçº§åœæœºï¼Œä»…é€‚ç”¨äº 3.13.x â†’ 4.x

å‡çº§è·¯å¾„

```bash
# å‡è®¾å½“å‰æ˜¯ 3.13.7
# 1. å…ˆå‡çº§åˆ°æœ€æ–°çš„ 3.13.x
apt-get install rabbitmq-server=3.13.7-1

# 2. å¯ç”¨æ‰€æœ‰ç‰¹æ€§æ ‡å¿—ï¼ˆå…³é”®ï¼ï¼‰
rabbitmqctl enable_feature_flag all

# 3. é€ä¸ªèŠ‚ç‚¹å‡çº§åˆ° 4.0.x
# èŠ‚ç‚¹1
rabbitmqctl stop_app
# å‡çº§åŒ…
apt-get install rabbitmq-server=4.0.8-1
rabbitmqctl start_app

# ç­‰å¾…é›†ç¾¤åŒæ­¥ï¼Œç„¶åå‡çº§èŠ‚ç‚¹2ã€3...
```

é£é™©ç‚¹
- å‡çº§æœŸé—´é›†ç¾¤å¤„äºæ··åˆç‰ˆæœ¬çŠ¶æ€ï¼Œéƒ¨åˆ†åŠŸèƒ½å—é™
- å¿…é¡»ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹è¿è¡Œç›¸åŒ Erlang ç‰ˆæœ¬
- Classic Mirrored Queues éœ€è¦æå‰è¿ç§»åˆ° Quorum Queues

---

ğŸ”§ å…³é”®æ“ä½œå‘½ä»¤æ±‡æ€»

æ“ä½œ	å‘½ä»¤	
æ£€æŸ¥ç‰ˆæœ¬	`rabbitmqctl status \| grep "RabbitMQ versi

