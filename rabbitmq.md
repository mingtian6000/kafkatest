æˆ‘æ¥å¸®ä½ è¯»å– RabbitMQ å®˜æ–¹æ–‡æ¡£ï¼Œç„¶åä¸ºä½ åˆ¶å®šä¸€ä¸ªä» 3.x å‡çº§åˆ° 4.x çš„è¯¦ç»†æ–¹æ¡ˆã€‚

è®©æˆ‘æœç´¢ä¸€ä¸‹ RabbitMQ 3 åˆ° 4 å‡çº§çš„å®˜æ–¹æ–‡æ¡£å’Œæœ€ä½³å®è·µï¼š

åŸºäºæœç´¢åˆ°çš„å®˜æ–¹æ–‡æ¡£å’Œç¤¾åŒºæœ€ä½³å®è·µï¼Œæˆ‘ä¸ºä½ åˆ¶å®šäº†ä¸€ä»½è¯¦ç»†çš„ RabbitMQ 3.x â†’ 4.x ç”Ÿäº§ç¯å¢ƒå‡çº§æ–¹æ¡ˆã€‚

---

ğŸ¯ æ–¹æ¡ˆæ¦‚è¿°

RabbitMQ 4.x ç›¸æ¯” 3.x æœ‰é‡å¤§æ¶æ„å˜åŒ–ï¼ˆå¦‚å¼ºåˆ¶ Quorum Queuesã€ç§»é™¤ Classic Mirrored Queuesã€Erlang ç‰ˆæœ¬è¦æ±‚ç­‰ï¼‰ï¼Œå› æ­¤ä¸æ”¯æŒç›´æ¥ä» 3.9 æˆ–æ›´ä½ç‰ˆæœ¬å‡çº§åˆ° 4.xã€‚

æ¨èæ–¹æ¡ˆï¼šBlue-Green éƒ¨ç½²ï¼ˆé›¶åœæœºï¼‰

è¿™æ˜¯ç”Ÿäº§ç¯å¢ƒæœ€å®‰å…¨çš„é€‰æ‹©ï¼Œå¯ä»¥å®Œå…¨ä¿ç•™æ•°æ®å¹¶å®ç°æ— ç¼åˆ‡æ¢ã€‚

è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é—®é¢˜ï¼è®©æˆ‘æœç´¢ä¸€ä¸‹ RabbitMQ å®˜æ–¹å…³äºç‰ˆæœ¬å‡çº§è·¯å¾„çš„å…·ä½“è§£é‡Šï¼š

å¤ªå¥½äº†ï¼Œæˆ‘æ‰¾åˆ°äº†å®˜æ–¹è§£é‡Šï¼è®©æˆ‘ä¸ºä½ è¯¦ç»†è§£é‡Šä¸ºä»€ä¹ˆå¿…é¡»ä» 3.13 æ‰èƒ½å‡çº§åˆ° 4.xï¼Œè€Œä¸èƒ½ä» 3.11 ç›´æ¥è·³è¿‡å»ã€‚

---

ğŸ” æ ¸å¿ƒåŸå› ï¼šç‰¹æ€§æ ‡å¿—ï¼ˆFeature Flagsï¼‰æœºåˆ¶

RabbitMQ ä» 3.8 å¼€å§‹å¼•å…¥ Feature Flags æœºåˆ¶ï¼Œè¿™æ˜¯ä¸ºäº†å…è®¸é›†ç¾¤åœ¨ä¸ä¸­æ–­æœåŠ¡çš„æƒ…å†µä¸‹é€æ­¥å¯ç”¨æ–°åŠŸèƒ½ã€‚ä½†è¿™ä¹Ÿå¯¼è‡´äº†ç‰ˆæœ¬å‡çº§çš„ç¡¬æ€§ä¾èµ–é“¾ã€‚

å®˜æ–¹æ˜ç¡®å£°æ˜ï¼š

> "This release series only supports upgrades from `3.13.x`. This release requires all feature flags in the 3.x series (specifically `3.13.x`) to be enabled before upgrading, there is no upgrade path from 3.12.14 (or a later patch release) straight to `4.0.0`."

"You can only upgrade to RabbitMQ 4.0 from RabbitMQ 3.13.x. Don't forget to enable all stable feature flags while still on 3.13, before attempting an upgrade to RabbitMQ 4.0, or the upgrade will fail."

---

ğŸ§© ä¸ºä»€ä¹ˆä¸èƒ½è·³è¿‡ 3.12 â†’ 3.13 ç›´æ¥åˆ° 4.0ï¼Ÿ

1. ç‰¹æ€§æ ‡å¿—çš„ç´¯ç§¯ä¾èµ–

æ¯ä¸ªæ¬¡è¦ç‰ˆæœ¬ï¼ˆ3.11ã€3.12ã€3.13ï¼‰éƒ½ä¼šå¼•å…¥æ–°çš„ç‰¹æ€§æ ‡å¿—ï¼Œè€Œè¿™äº›æ ‡å¿—åœ¨åç»­ç‰ˆæœ¬ä¸­ä¼šå˜æˆå¿…éœ€ï¼ˆRequiredï¼‰ï¼š

ç‰ˆæœ¬	å¼•å…¥çš„æ–°ç‰¹æ€§æ ‡å¿—ï¼ˆéƒ¨åˆ†å…³é”®ï¼‰	åˆ°ä¸‹ä¸€ç‰ˆæœ¬çš„è¦æ±‚	
3.11	`classic_mirrored_queue_version`, `quorum_queue` ç­‰	3.12 è¦æ±‚è¿™äº›å¿…é¡»å¯ç”¨	
3.12	`stream_filtering`, `stream_queue_coordinator_procs` ç­‰	3.13 è¦æ±‚è¿™äº›å¿…é¡»å¯ç”¨	
3.13	`detailed_queues_endpoint`, `message_containers`, `stream_update_config_command` ç­‰	4.0 è¦æ±‚è¿™äº›å¿…é¡»å¯ç”¨	

å…³é”®é—®é¢˜ï¼š3.11 æ ¹æœ¬ä¸çŸ¥é“ 3.13 å’Œ 4.0 éœ€è¦å“ªäº›ç‰¹æ€§æ ‡å¿—ï¼

çœ‹ä¸€ä¸ªçœŸå®æ¡ˆä¾‹ï¼š
- ç”¨æˆ·ä» 3.12.10 ç›´æ¥å‡çº§åˆ° 4.0.5
- æŠ¥é”™ï¼š`Feature flags: 'stream_filtering': required feature flag not enabled!`
- å›æ»šåˆ° 3.12.10 åå‘ç°æ ¹æœ¬æ²¡æœ‰ `stream_filtering` è¿™ä¸ªæ ‡å¿—ï¼
- å› ä¸ºè¿™ä¸ªæ ‡å¿—æ˜¯åœ¨ 3.13 æ‰å¼•å…¥çš„ï¼Œ3.12 æ— æ³•å¯ç”¨ä¸€ä¸ªä¸å­˜åœ¨çš„æ ‡å¿—

2. Schema æ•°æ®åº“ï¼ˆMnesia/Khepriï¼‰çš„å…ƒæ•°æ®æ ¼å¼å˜æ›´

RabbitMQ ä½¿ç”¨ Mnesiaï¼ˆ3.x é»˜è®¤ï¼‰æˆ– Khepriï¼ˆ4.x å¯é€‰ï¼‰å­˜å‚¨å…ƒæ•°æ®ã€‚æ¯æ¬¡ç‰ˆæœ¬å‡çº§éƒ½å¯èƒ½æ¶‰åŠï¼š

- å†…éƒ¨è¡¨ç»“æ„å˜æ›´ï¼ˆå¦‚é˜Ÿåˆ—å…ƒæ•°æ®ã€ç»‘å®šä¿¡æ¯å­˜å‚¨æ ¼å¼ï¼‰
- Erlang æœ¯è¯­ï¼ˆTermï¼‰æ ¼å¼çš„å…¼å®¹æ€§
- é›†ç¾¤çŠ¶æ€æœºçš„åè®®å˜æ›´

3.13 æ˜¯ 3.x ç³»åˆ—çš„æœ€åä¸€ä¸ªç‰ˆæœ¬ï¼Œå®ƒåŒ…å«äº†æ‰€æœ‰ 3.x æ—¶ä»£çš„å…ƒæ•°æ®è¿ç§»é€»è¾‘ã€‚4.0 åªä¿ç•™äº†ä» 3.13 æ ¼å¼è¿ç§»åˆ° 4.0 æ ¼å¼çš„é€»è¾‘ï¼Œæ²¡æœ‰ä¿ç•™ä» 3.11 æˆ– 3.12 è¿ç§»çš„é€»è¾‘ã€‚

3. Khepri å…ƒæ•°æ®å­˜å‚¨çš„é‡å¤§å˜æ›´

RabbitMQ åœ¨ 3.13 å®éªŒæ€§å¼•å…¥äº† Khepri ä½œä¸º Mnesia çš„æ›¿ä»£ï¼š
- 3.13 çš„ Khepri å®ç°ä¸ 4.0 çš„ Khepri ä¸å…¼å®¹
- å¦‚æœåœ¨ 3.13 å¯ç”¨äº† `khepri_db` ç‰¹æ€§æ ‡å¿—ï¼Œåè€Œä¸èƒ½å‡çº§åˆ° 4.0
- 4.0 çš„ Khepri æ˜¯ç¨³å®šç‰ˆï¼Œå†…éƒ¨å®ç°æœ‰é‡å¤§å˜æ›´

è¿™è¿›ä¸€æ­¥è¯æ˜äº† 3.13 æ˜¯ä¸€ä¸ª"è½¬æ¢å«"ç‰ˆæœ¬ï¼Œè´Ÿè´£å¤„ç†æ‰€æœ‰ 3.x åˆ° 4.x çš„è¿‡æ¸¡é€»è¾‘ã€‚

---

ğŸ›¡ï¸ ä¸ºä»€ä¹ˆ Blue-Green å¯ä»¥è·³è¿‡ä¸­é—´ç‰ˆæœ¬ï¼Ÿ

ä½ ä»¬è®¡åˆ’ç”¨ Blue-Green å‡çº§ï¼Œè¿™ç¡®å®æ˜¯å”¯ä¸€å¯ä»¥è·³è¿‡ä¸­é—´ç‰ˆæœ¬çš„æ–¹æ³•ï¼š

> "Alternatively, instead of a series of upgrades, you can use a Blue/Green upgrade and move directly to `4.0.x` that way. It is more involved but works even for multi-minor gaps, e.g. 3.8.x => 4.0.x upgrades."

åŸå› ï¼š
- Blue-Green æ˜¯è¿ç§»ï¼ˆMigrationï¼‰è€Œéå‡çº§ï¼ˆUpgradeï¼‰
- ä½ åœ¨ Green é›†ç¾¤ï¼ˆ4.xï¼‰æ˜¯å…¨æ–°éƒ¨ç½²ï¼Œä¸ç»§æ‰¿ Blue é›†ç¾¤ï¼ˆ3.xï¼‰çš„å…ƒæ•°æ®çŠ¶æ€
- é€šè¿‡ Federation/Shovel åŒæ­¥çš„æ˜¯æ¶ˆæ¯æ•°æ®ï¼Œè€Œéé›†ç¾¤å…ƒæ•°æ®
- 4.x åªéœ€è¦å¤„ç†æ¶ˆæ¯æ ¼å¼ï¼Œè€Œæ¶ˆæ¯æ ¼å¼ï¼ˆAMQP 0-9-1/1.0ï¼‰åœ¨ 3.x å’Œ 4.x ä¹‹é—´æ˜¯å…¼å®¹çš„

---

ğŸ“‹ å…·ä½“åˆ°ä½ çš„æƒ…å†µï¼ˆ3.11 â†’ 4.xï¼‰

å¦‚æœé€‰æ‹©åŸåœ°æ»šåŠ¨å‡çº§ï¼ˆä¸æ¨èï¼‰ï¼š

```
3.11.9 â†’ 3.11.18 â†’ 3.12.x â†’ 3.13.x â†’ 4.0.x
```

æ¯ä¸ªç®­å¤´éƒ½æ˜¯ä¸€æ¬¡é›†ç¾¤é‡å¯+å…ƒæ•°æ®è¿ç§»ï¼Œç”Ÿäº§ç¯å¢ƒé£é™©æé«˜ã€‚

å¦‚æœé€‰æ‹©Blue-Greenï¼ˆæ¨èï¼‰ï¼š

```
3.11.x (Blue) â”€â”€Federation/Shovelâ”€â”€â–º 4.0.x (Green)
         \                          /
          \_____ ç›´æ¥åˆ‡æ¢æµé‡ _______/
```

è·³è¿‡æ‰€æœ‰ä¸­é—´ç‰ˆæœ¬ï¼Œå› ä¸º Green æ˜¯å…¨æ–°é›†ç¾¤ï¼Œæ²¡æœ‰å†å²åŒ…è¢±ã€‚

---

âš ï¸ é‡è¦æé†’

å³ä½¿ä½¿ç”¨ Blue-Greenï¼Œä¹Ÿè¦æ³¨æ„ï¼š

1. å®¢æˆ·ç«¯å…¼å®¹æ€§ï¼šç¡®ä¿ç”Ÿäº§è€…/æ¶ˆè´¹è€…å®¢æˆ·ç«¯æ”¯æŒ 4.xï¼ˆå¦‚ C# å®¢æˆ·ç«¯éœ€ 7.0+ï¼‰
2. é˜Ÿåˆ—ç±»å‹ï¼š3.11 çš„ Classic Mirrored Queues åœ¨ 4.x å·²ç§»é™¤ï¼Œéœ€è¦æå‰è¿ç§»åˆ° Quorum Queues
3. Erlang ç‰ˆæœ¬ï¼š4.x è¦æ±‚ Erlang 26.2+ï¼Œä¸ 3.11 å¯èƒ½ä¸å…¼å®¹
4. é…ç½®å˜æ›´ï¼š4.x æœ‰ä¸€äº›é…ç½®é¡¹å˜åŒ–ï¼ˆå¦‚ MQTT é»˜è®¤ç”¨æˆ·é…ç½®ï¼‰

---

ğŸ¯ æ€»ç»“

é—®é¢˜	ç­”æ¡ˆ	
ä¸ºä»€ä¹ˆä¸èƒ½ 3.11 â†’ 4.0ï¼Ÿ	3.11 ç¼ºå°‘ 3.12/3.13 å¼•å…¥çš„ç‰¹æ€§æ ‡å¿—ï¼Œæ— æ³•å¯ç”¨ 4.0 æ‰€éœ€çš„æ ‡å¿—	
ä¸ºä»€ä¹ˆå¿…é¡» 3.13 æ‰èƒ½åˆ° 4.0ï¼Ÿ	3.13 æ˜¯ 3.x æœ€åä¸€ä¸ªç‰ˆæœ¬ï¼ŒåŒ…å«æ‰€æœ‰åˆ° 4.x çš„è¿ç§»é€»è¾‘	
Blue-Green ä¸ºä»€ä¹ˆå¯ä»¥è·³è¿‡ï¼Ÿ	å› ä¸ºæ˜¯æ–°å»ºé›†ç¾¤ï¼Œä¸æ¶‰åŠå…ƒæ•°æ®è¿ç§»ï¼ŒåªåŒæ­¥æ¶ˆæ¯	
ç”Ÿäº§ç¯å¢ƒæ¨èï¼Ÿ	Blue-Greenï¼Œé›¶åœæœºã€å¯å›æ»šã€è·³è¿‡ä¸­é—´ç‰ˆæœ¬	

ä½ ä»¬çš„ Blue-Green æ–¹æ¡ˆæ˜¯æœ€æ˜æ™ºçš„é€‰æ‹©ï¼Œæ—¢é¿å…äº†å¤æ‚çš„é˜¶æ¢¯å‡çº§ï¼Œåˆä¿è¯äº†ç”Ÿäº§ç¨³å®šæ€§ã€‚

---

ğŸ“‹ å‰ç½®æ£€æŸ¥æ¸…å•

1. å½“å‰ç‰ˆæœ¬ç¡®è®¤

```bash
# æ£€æŸ¥å½“å‰ç‰ˆæœ¬
rabbitmqctl status | grep "RabbitMQ version"
# æˆ–
rabbitmq-diagnostics status
```

å‡çº§è·¯å¾„è¦æ±‚ï¼ˆå¿…é¡»ä¸¥æ ¼æ‰§è¡Œï¼‰ï¼š
- å¦‚æœå½“å‰æ˜¯ 3.9.xï¼š3.9 â†’ 3.10 â†’ 3.11 â†’ 3.12 â†’ 3.13.x â†’ 4.x
- å¦‚æœå½“å‰æ˜¯ 3.13.xï¼šå¯ä»¥ç›´æ¥å‡çº§åˆ° 4.x

2. å…³é”®å˜æ›´æ£€æŸ¥ï¼ˆ4.x ç ´åæ€§å˜æ›´ï¼‰
- Classic Mirrored Queues å·²ç§»é™¤ â†’ å¿…é¡»è¿ç§»åˆ° Quorum Queues
- Erlang ç‰ˆæœ¬è¦æ±‚ï¼šæœ€ä½ Erlang 25.0ï¼ˆæ¨è 26.x+ï¼‰
- å®¢æˆ·ç«¯å…¼å®¹æ€§ï¼šC# å®¢æˆ·ç«¯éœ€å‡çº§è‡³ 7.0+ï¼ŒJava å®¢æˆ·ç«¯éœ€ 5.18+
- ç‰¹æ€§æ ‡å¿—ï¼ˆFeature Flagsï¼‰ï¼š3.13 å¿…é¡»å¯ç”¨æ‰€æœ‰ç‰¹æ€§æ ‡å¿—æ‰èƒ½å‡çº§åˆ° 4.x

---

ğŸš€ æ¨èæ–¹æ¡ˆï¼šBlue-Green é›¶åœæœºå‡çº§

æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”Ÿäº§æµé‡                                 â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   ç”Ÿäº§è€…      â”‚â”€â”€â”€â”€â”€â–¶â”‚  Load        â”‚â”€â”€â”€â”€â”€â–¶â”‚   æ¶ˆè´¹è€…      â”‚   â”‚
â”‚  â”‚  (Producers) â”‚      â”‚  Balancer    â”‚      â”‚ (Consumers)   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                               â”‚                                  â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                    â”‚                     â”‚                       â”‚
â”‚                    â–¼                     â–¼                       â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚           â”‚  Blue é›†ç¾¤   â”‚â—„â”€â”€â”€â”€â–ºâ”‚  Green é›†ç¾¤  â”‚                  â”‚
â”‚           â”‚  (å½“å‰ 3.x)  â”‚      â”‚  (æ–° 4.x)   â”‚                  â”‚
â”‚           â”‚             â”‚      â”‚             â”‚                  â”‚
â”‚           â”‚ â€¢ ç°æœ‰æ•°æ®   â”‚      â”‚ â€¢ å…¨æ–°éƒ¨ç½²   â”‚                  â”‚
â”‚           â”‚ â€¢ é€æ­¥è¿ç§»   â”‚      â”‚ â€¢ åŒæ­¥æ•°æ®   â”‚                  â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                  â”‚                      â”‚                        â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                             â”‚                                    â”‚
â”‚                             â–¼                                    â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚                    â”‚  Federation â”‚  (é˜Ÿåˆ—è”é‚¦åŒæ­¥æ¶ˆæ¯)             â”‚
â”‚                    â”‚   Plugin    â”‚                               â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

è¯¦ç»†å®æ–½æ­¥éª¤

Phase 1: å‡†å¤‡é˜¶æ®µï¼ˆ1-2å¤©ï¼‰

1.1 éƒ¨ç½² Green é›†ç¾¤ï¼ˆRabbitMQ 4.xï¼‰

```bash
# åœ¨æ–°æœåŠ¡å™¨/K8s å‘½åç©ºé—´éƒ¨ç½² 4.x é›†ç¾¤
# ç¡®ä¿é…ç½®ä¸ Blue é›†ç¾¤ä¸€è‡´ï¼š
# - ç›¸åŒçš„ Erlang Cookie
# - ç›¸åŒçš„ç”¨æˆ·/å¯†ç 
# - ç›¸åŒçš„ vhost ç»“æ„
```

1.2 å¯¼å‡º Blue é›†ç¾¤é…ç½®

```bash
# ä½¿ç”¨ rabbitmqadmin v2 å¯¼å‡ºå®šä¹‰ï¼ˆé˜Ÿåˆ—ã€äº¤æ¢æœºã€ç»‘å®šã€ç”¨æˆ·ç­‰ï¼‰
rabbitmqadmin export definitions.json

# æˆ–ä½¿ç”¨ HTTP API
curl -u user:password http://blue-cluster:15672/api/definitions > definitions.json
```

1.3 å¯¼å…¥åˆ° Green é›†ç¾¤

```bash
rabbitmqadmin -H green-cluster import definitions.json
```

1.4 å¯ç”¨ Federation æ’ä»¶ï¼ˆå…³é”®æ­¥éª¤ï¼‰

```bash
# åœ¨ Green é›†ç¾¤ï¼ˆ4.xï¼‰ä¸Šæ‰§è¡Œ
rabbitmq-plugins enable rabbitmq_federation rabbitmq_federation_management

# é…ç½® Federation Upstreamï¼ˆæŒ‡å‘ Blue é›†ç¾¤ï¼‰
rabbitmqctl set_parameter federation-upstream blue_cluster_upstream \
  '{"uri": "amqp://user:password@blue-node1:5672,amqp://user:password@blue-node2:5672"}'

# åˆ›å»º Policy è‡ªåŠ¨åŒæ­¥æ‰€æœ‰é˜Ÿåˆ—
rabbitmqctl set_policy --apply-to queues blue-green-migration ".*" \
  '{"federation-upstream":"blue_cluster_upstream"}' --priority 1
```

Phase 2: æ•°æ®åŒæ­¥é˜¶æ®µï¼ˆ1-7å¤©ï¼Œè§†æ•°æ®é‡ï¼‰

2.1 ç›‘æ§åŒæ­¥çŠ¶æ€

```bash
# æŸ¥çœ‹ Federation çŠ¶æ€
rabbitmqctl federation_status

# ç¡®ä¿é˜Ÿåˆ—æ¶ˆæ¯åŒæ­¥å®Œæˆ
rabbitmqctl list_queues name messages_ready messages_unacknowledged
```

2.2 éªŒè¯ Green é›†ç¾¤å¥åº·
- æ£€æŸ¥ 4.x ç‰¹æ€§æ ‡å¿—æ˜¯å¦å…¨éƒ¨å¯ç”¨
- éªŒè¯ Quorum Queues æ­£å¸¸å·¥ä½œï¼ˆå¦‚é€‚ç”¨ï¼‰
- æµ‹è¯•å®¢æˆ·ç«¯è¿æ¥

Phase 3: æµé‡åˆ‡æ¢é˜¶æ®µï¼ˆåˆ†é’Ÿçº§åœæœºï¼‰

3.1 ç”Ÿäº§è€…åˆ‡æ¢ï¼ˆå…ˆåˆ‡ç”Ÿäº§è€…ï¼‰

```bash
# æ›´æ–° DNS æˆ–é…ç½®ä¸­å¿ƒï¼Œå°†ç”Ÿäº§è€…æŒ‡å‘ Green é›†ç¾¤
# ä½¿ç”¨è“ç»¿å‘å¸ƒæˆ–é…ç½®ä¸­å¿ƒçƒ­æ›´æ–°
```

3.2 ç­‰å¾… Blue é˜Ÿåˆ—æ¶ˆè´¹å®Œæ¯•

```bash
# ç›‘æ§ Blue é›†ç¾¤é˜Ÿåˆ—æ·±åº¦
watch 'rabbitmqctl list_queues name messages_ready'

# ç›´åˆ°æ‰€æœ‰é˜Ÿåˆ—ä¸ºç©º
```

3.3 æ¶ˆè´¹è€…åˆ‡æ¢

```bash
# å°†æ¶ˆè´¹è€…åˆ‡æ¢åˆ° Green é›†ç¾¤
# æ­¤æ—¶ä¸šåŠ¡å®Œå…¨è¿è¡Œåœ¨ 4.x ä¸Š
```

3.4 ä¿ç•™ Blue é›†ç¾¤ï¼ˆå›æ»šä¿é™©ï¼‰

```bash
# ä¿æŒ Blue é›†ç¾¤è¿è¡Œ 24-72 å°æ—¶
# å¦‚é‡é—®é¢˜å¯ç«‹å³åˆ‡å›
```

Phase 4: æ¸…ç†é˜¶æ®µ

4.1 ç¡®è®¤ç¨³å®šåä¸‹çº¿ Blue

```bash
# åœæ­¢ Federation
rabbitmqctl clear_policy blue-green-migration
rabbitmqctl clear_parameter federation-upstream blue_cluster_upstream

# ä¼˜é›…å…³é—­ Blue é›†ç¾¤
rabbitmqctl stop
```

---

âš¡ å¤‡é€‰æ–¹æ¡ˆï¼šæ»šåŠ¨å‡çº§ï¼ˆå¦‚æœå¿…é¡»ä½¿ç”¨åŒä¸€é›†ç¾¤ï¼‰

âš ï¸ è­¦å‘Šï¼šæ­¤æ–¹æ¡ˆæœ‰åˆ†é’Ÿçº§åœæœºï¼Œä»…é€‚ç”¨äº 3.13.x â†’ 4.x

å‡çº§è·¯å¾„

```bash
# å‡è®¾å½“å‰æ˜¯ 3.13.7
# 1. å…ˆå‡çº§åˆ°æœ€æ–°çš„ 3.13.x
apt-get install rabbitmq-server=3.13.7-1

# 2. å¯ç”¨æ‰€æœ‰ç‰¹æ€§æ ‡å¿—ï¼ˆå…³é”®ï¼ï¼‰
rabbitmqctl enable_feature_flag all

# 3. é€ä¸ªèŠ‚ç‚¹å‡çº§åˆ° 4.0.x
# èŠ‚ç‚¹1
rabbitmqctl stop_app
# å‡çº§åŒ…
apt-get install rabbitmq-server=4.0.8-1
rabbitmqctl start_app

# ç­‰å¾…é›†ç¾¤åŒæ­¥ï¼Œç„¶åå‡çº§èŠ‚ç‚¹2ã€3...
```

é£é™©ç‚¹
- å‡çº§æœŸé—´é›†ç¾¤å¤„äºæ··åˆç‰ˆæœ¬çŠ¶æ€ï¼Œéƒ¨åˆ†åŠŸèƒ½å—é™
- å¿…é¡»ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹è¿è¡Œç›¸åŒ Erlang ç‰ˆæœ¬
- Classic Mirrored Queues éœ€è¦æå‰è¿ç§»åˆ° Quorum Queues

---

ğŸ”§ å…³é”®æ“ä½œå‘½ä»¤æ±‡æ€»

æ“ä½œ	å‘½ä»¤	
æ£€æŸ¥ç‰ˆæœ¬	`rabbitmqctl status \| grep "RabbitMQ versi

è¿™æ˜¯ä¸€ä¸ªå…³äº RabbitMQ å­˜å‚¨æœºåˆ¶å’Œæµæ§çš„æ ¸å¿ƒé—®é¢˜ã€‚è®©æˆ‘æœç´¢ä¸€ä¸‹å®˜æ–¹å…³äºé˜Ÿåˆ—å­˜å‚¨ã€æŒä¹…åŒ–å’ŒèƒŒå‹ï¼ˆBack Pressureï¼‰æœºåˆ¶çš„è¯¦ç»†è¯´æ˜ï¼š

æ ¹æ®æœç´¢åˆ°çš„å®˜æ–¹æ–‡æ¡£å’Œæœ€ä½³å®è·µï¼Œæˆ‘æ¥ä¸ºä½ è¯¦ç»†è§£é‡Š RabbitMQ çš„å­˜å‚¨æœºåˆ¶å’Œé˜Ÿåˆ—çˆ†æ»¡æ—¶çš„å¤„ç†ç­–ç•¥ï¼š

---

ğŸ“¦ RabbitMQ é˜Ÿåˆ—å­˜å‚¨æœºåˆ¶è¯¦è§£

1. å­˜å‚¨ä½ç½®ï¼šå†…å­˜ vs ç£ç›˜

RabbitMQ çš„å­˜å‚¨ç­–ç•¥å–å†³äºé˜Ÿåˆ—ç±»å‹å’Œæ¶ˆæ¯æŒä¹…åŒ–è®¾ç½®ï¼š

é˜Ÿåˆ—ç±»å‹	é»˜è®¤å­˜å‚¨è¡Œä¸º	é…ç½®é€‰é¡¹	
Classic Queue (v1/v2)	æ¶ˆæ¯å…ˆå­˜å†…å­˜ï¼Œå†…å­˜å‹åŠ›å¤§æ—¶åˆ·ç›˜	`x-queue-mode: lazy`	
Lazy Queue	æ¶ˆæ¯ç›´æ¥å†™ç£ç›˜ï¼Œåªä¿ç•™ç´¢å¼•åœ¨å†…å­˜	3.6+ å¯ç”¨	
Quorum Queue	ç£ç›˜ä¸ºä¸»ï¼Œå†…å­˜ç¼“å­˜éƒ¨åˆ†æ¶ˆæ¯	`x-max-in-memory-length`	

æŒä¹…åŒ–å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æŒä¹…åŒ–å±‚ (Persistence Layer)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ¶ˆæ¯å­˜å‚¨ (Message Store)                                â”‚
â”‚  â”œâ”€â”€ ç¬æ€æ¶ˆæ¯å­˜å‚¨ (Transient) - å†…å­˜ä¸è¶³æ—¶å†™å…¥            â”‚
â”‚  â””â”€â”€ æŒä¹…æ¶ˆæ¯å­˜å‚¨ (Persistent) - ç«‹å³å†™å…¥ç£ç›˜             â”‚
â”‚                                                         â”‚
â”‚  é˜Ÿåˆ—ç´¢å¼• (Queue Index) - æ¯ä¸ªé˜Ÿåˆ—ç‹¬ç«‹                    â”‚
â”‚  â”œâ”€â”€ è®°å½•æ¶ˆæ¯åœ¨æ¶ˆæ¯å­˜å‚¨ä¸­çš„ä½ç½®                           â”‚
â”‚  â”œâ”€â”€ è®°å½•æ¶ˆæ¯æ˜¯å¦è¢«ç¡®è®¤ (ack)                            â”‚
â”‚  â””â”€â”€ å°æ¶ˆæ¯ (<4KB) å¯ç›´æ¥åµŒå…¥ç´¢å¼•                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

å…³é”®ç‰¹æ€§ï¼š
- å°æ¶ˆæ¯ä¼˜åŒ–ï¼šå°äº 4KB çš„æ¶ˆæ¯ç›´æ¥åµŒå…¥é˜Ÿåˆ—ç´¢å¼•ï¼Œå‡å°‘ I/O
- å…±äº«å­˜å‚¨ï¼šæ‰€æœ‰é˜Ÿåˆ—å…±äº«åŒä¸€ä¸ªæ¶ˆæ¯å­˜å‚¨æ–‡ä»¶ï¼Œä½†æ¯ä¸ªé˜Ÿåˆ—æœ‰è‡ªå·±çš„ç´¢å¼•
- ç‰ˆæœ¬å·®å¼‚ï¼šClassic Queue v2 å¼•å…¥äº†æ¯é˜Ÿåˆ—æ¶ˆæ¯å­˜å‚¨ï¼Œå¤§æ¶ˆæ¯å­˜å…±äº«å­˜å‚¨ï¼Œå°æ¶ˆæ¯å­˜é˜Ÿåˆ—ä¸“å±å­˜å‚¨

---

ğŸš¨ é˜Ÿåˆ—çˆ†æ»¡æ—¶çš„å¤„ç†æœºåˆ¶

å½“é˜Ÿåˆ—æ¶ˆæ¯é‡æ¿€å¢æ—¶ï¼ŒRabbitMQ ä¼šå¯åŠ¨å¤šçº§æµæ§ï¼ˆFlow Controlï¼‰æœºåˆ¶ï¼š

Level 1: å†…å­˜åˆ†é¡µï¼ˆPagingï¼‰
å½“å†…å­˜ä½¿ç”¨è¶…è¿‡ `vm_memory_high_watermark_paging_ratio`ï¼ˆé»˜è®¤ 50% çš„æ°´ä½çº¿ï¼‰ï¼š

```erlang
# rabbitmq.conf
vm_memory_high_watermark.relative = 0.6      # å†…å­˜å‘Šè­¦é˜ˆå€¼ 60%
vm_memory_high_watermark_paging_ratio = 0.5  # è¾¾åˆ° 30% æ—¶å¼€å§‹åˆ·ç›˜ (60% * 0.5)
```

è¡Œä¸ºï¼š
- å°†å†…å­˜ä¸­çš„æ¶ˆæ¯æ‰¹é‡å†™å…¥ç£ç›˜
- é‡Šæ”¾å†…å­˜ç©ºé—´
- ä¸é˜»å¡å‘å¸ƒè€…ï¼Œä½†æ€§èƒ½ä¸‹é™

Level 2: å†…å­˜å‘Šè­¦ï¼ˆMemory Alarmï¼‰
å½“å†…å­˜ä½¿ç”¨è¶…è¿‡ `vm_memory_high_watermark`ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å†…å­˜å‘Šè­¦è§¦å‘ (Memory Alarm)      â”‚
â”‚              å†…å­˜ â‰¥ 60%                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”´ é˜»å¡æ‰€æœ‰å‘å¸ƒè€…è¿æ¥ (Blocking)        â”‚
â”‚  âœ… æ¶ˆè´¹è€…ç»§ç»­æ¶ˆè´¹ (Consumers OK)        â”‚
â”‚  ğŸ”„ ç­‰å¾…å†…å­˜ä¸‹é™åè‡ªåŠ¨æ¢å¤               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

å½±å“ï¼š
- æ‰€æœ‰å‘å¸ƒè¿æ¥æ”¶åˆ° `connection.blocked` é€šçŸ¥
- æ–°æ¶ˆæ¯æ— æ³•å‘å¸ƒ
- ç°æœ‰æ¶ˆè´¹è€…ç»§ç»­å¤„ç†ï¼Œç›´åˆ°å†…å­˜ä¸‹é™

Level 3: ç£ç›˜å‘Šè­¦ï¼ˆDisk Alarmï¼‰
å½“ç£ç›˜å‰©ä½™ç©ºé—´ä½äº `disk_free_limit`ï¼š

```erlang
# rabbitmq.conf
disk_free_limit.absolute = 2GB    # ç»å¯¹å€¼
# æˆ–
disk_free_limit.relative = 1.5    # ç›¸å¯¹äºå†…å­˜çš„å€æ•°ï¼ˆé»˜è®¤ 1.0xï¼‰
```

è¡Œä¸ºï¼š
- åŒæ ·é˜»å¡å‘å¸ƒè€…
- é˜²æ­¢ RabbitMQ å› æ— æ³•æŒä¹…åŒ–è€Œå´©æºƒ

---

ğŸ›¡ï¸ ç”Ÿäº§ç¯å¢ƒé˜²æŠ¤ç­–ç•¥

1. é˜Ÿåˆ—ç±»å‹é€‰æ‹©

é«˜ç§¯å‹åœºæ™¯ï¼ˆæ¨è Lazy Queueï¼‰ï¼š

```python
channel.queue_declare(
    queue='high_backlog_queue',
    durable=True,
    arguments={
        'x-queue-mode': 'lazy'  # æ¶ˆæ¯ç›´æ¥è½ç›˜ï¼Œå†…å­˜åªå­˜ç´¢å¼•
    }
)
```

æ•ˆæœï¼š10ä¸‡æ¡ Ã— 10KB æ¶ˆæ¯ï¼ŒClassic Queue å ç”¨ 1GB RAMï¼ŒLazy Queue ä»… 100MB

é«˜å¯ç”¨åœºæ™¯ï¼ˆæ¨è Quorum Queue + å†…å­˜é™åˆ¶ï¼‰ï¼š

```python
channel.queue_declare(
    queue='production_queue',
    durable=True,
    arguments={
        'x-queue-type': 'quorum',
        'x-max-in-memory-length': 1000,     # å†…å­˜æœ€å¤šä¿ç•™ 1000 æ¡
        'x-max-in-memory-bytes': 104857600  # æˆ–æœ€å¤š 100MB
    }
)
```

2. ç¡¬é™åˆ¶ï¼šé˜Ÿåˆ—é•¿åº¦å’Œ TTL

```python
# é™åˆ¶é˜Ÿåˆ—æœ€å¤§é•¿åº¦ï¼Œè¶…é™æ‹’ç»æ–°æ¶ˆæ¯
channel.queue_declare(
    queue='bounded_queue',
    arguments={
        'x-max-length': 100000,           # æœ€å¤š 10 ä¸‡æ¡
        'x-overflow': 'reject-publish'    # æ»¡æ—¶æ‹’ç»å‘å¸ƒï¼ˆå¯æ”¹ä¸º drop-headï¼‰
    }
)

# æˆ–è®¾ç½®æ¶ˆæ¯è¿‡æœŸæ—¶é—´
channel.queue_declare(
    queue='ttl_queue',
    arguments={
        'x-message-ttl': 3600000  # æ¶ˆæ¯ 1 å°æ—¶è¿‡æœŸ
    }
)
```

3. ç›‘æ§å‘Šè­¦é…ç½®

Prometheus å‘Šè­¦è§„åˆ™ï¼š

```yaml
groups:
  - name: rabbitmq_alarms
    rules:
      - alert: RabbitMQMemoryAlarm
        expr: rabbitmq_alarms_memory_used_watermark == 1
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "RabbitMQ å†…å­˜å‘Šè­¦ï¼Œå‘å¸ƒå·²è¢«é˜»å¡"

      - alert: RabbitMQQueueBuildup
        expr: rabbitmq_queue_messages_ready > 100000
        for: 5m
        annotations:
          summary: "é˜Ÿåˆ— {{ $labels.queue }} æ¶ˆæ¯å †ç§¯è¶…è¿‡ 10 ä¸‡"
```

---

ğŸ”¥ é˜Ÿåˆ—çˆ†æ»¡æ—¶çš„åº”æ€¥å¤„ç†

åœºæ™¯ 1ï¼šå†…å­˜å‘Šè­¦å·²è§¦å‘ï¼ˆå‘å¸ƒè¢«é˜»å¡ï¼‰

```bash
# 1. å¿«é€ŸæŸ¥çœ‹å †ç§¯æœ€ä¸¥é‡çš„é˜Ÿåˆ—
rabbitmqctl list_queues name messages memory --formatter json | \
  jq -r 'sort_by(.messages) | reverse | .[:5] | .[] | "\(.name): \(.messages) msgs"'

# 2. ç´§æ€¥æ‰©å®¹æ¶ˆè´¹è€…ï¼ˆå¦‚æœæ¶ˆè´¹è€…ä¸è¶³ï¼‰
# 3. æˆ–è€…ä¸´æ—¶å¢åŠ æ¶ˆè´¹è€… prefetch åŠ é€Ÿæ¶ˆè´¹
channel.basic_qos(prefetch_count=100)  # æé«˜é¢„å–æ•°é‡

# 4. æç«¯æƒ…å†µï¼šæ¸…ç©ºéå…³é”®é˜Ÿåˆ—ï¼ˆä¼šä¸¢å¤±æ¶ˆæ¯ï¼ï¼‰
rabbitmqctl purge_queue queue_name
```

åœºæ™¯ 2ï¼šç£ç›˜å‘Šè­¦å·²è§¦å‘

```bash
# 1. æ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µ
rabbitmqctl status | grep -A 5 "Disk"

# 2. æ¸…ç†æ—¥å¿—æ–‡ä»¶
rm -rf /var/log/rabbitmq/*.log.*

# 3. åˆ é™¤éå¿…è¦é˜Ÿåˆ—
rabbitmqctl delete_queue non_critical_queue

# 4. ä¸´æ—¶æé«˜ç£ç›˜é˜ˆå€¼ï¼ˆæ²»æ ‡ä¸æ²»æœ¬ï¼‰
rabbitmqctl set_disk_free_limit 1GB
```

åœºæ™¯ 3ï¼šLazy Queue ç£ç›˜ I/O ç“¶é¢ˆ

```bash
# ä¼˜åŒ–ç£ç›˜æ€§èƒ½
# 1. ä½¿ç”¨ XFS æ–‡ä»¶ç³»ç»Ÿï¼ˆä¼˜äº ext4ï¼‰
sudo mkfs.xfs -f /dev/sdb1

# 2. ç¦ç”¨ atime å‡å°‘ I/O
sudo mount -o remount,noatime /var/lib/rabbitmq

# 3. ä½¿ç”¨ç‹¬ç«‹ SSD å­˜å‚¨æ¶ˆæ¯
# åœ¨ rabbitmq.conf ä¸­é…ç½®ï¼š
# mq_queue_index_embed_msgs_below = 4096  # 4KB ä»¥ä¸‹æ¶ˆæ¯åµŒå…¥ç´¢å¼•
```

---

ğŸ“Š å…³é”®æŒ‡æ ‡ç›‘æ§

æŒ‡æ ‡	å‘Šè­¦é˜ˆå€¼	è¯´æ˜	
`rabbitmq_queue_messages_ready`	100,000	é˜Ÿåˆ—å †ç§¯	
`rabbitmq_process_resident_memory_bytes`	80% limit	å†…å­˜ä½¿ç”¨	
`rabbitmq_disk_free_alarm`	= 1	ç£ç›˜å‘Šè­¦	
`rabbitmq_connections_blocked`	0	è¢«é˜»å¡çš„è¿æ¥	
Consumer utilization	< 50%	æ¶ˆè´¹è€…æ•ˆç‡ä½	

---

ğŸ¯ æ€»ç»“

é—®é¢˜	ç­”æ¡ˆ	
é˜Ÿåˆ—å­˜åœ¨å“ªé‡Œï¼Ÿ	é»˜è®¤å†…å­˜+ç£ç›˜åŒä»½ï¼ŒLazy Queue ç›´æ¥å­˜ç£ç›˜	
çˆ†æ»¡æ—¶æ€ä¹ˆå¤„ç†ï¼Ÿ	å…ˆåˆ†é¡µåˆ·ç›˜ â†’ å†é˜»å¡å‘å¸ƒè€…ï¼ˆèƒŒå‹ï¼‰â†’ æœ€åç£ç›˜å‘Šè­¦	
å¦‚ä½•é¿å…ï¼Ÿ	ç”¨ Lazy Queue/Quorum Queue + è®¾ç½®é•¿åº¦é™åˆ¶ + ç›‘æ§å‘Šè­¦	
æ•°æ®ä¼šä¸¢å—ï¼Ÿ	æŒä¹…åŒ–æ¶ˆæ¯ä¸ä¼šï¼Œä½†éæŒä¹…åŒ–æ¶ˆæ¯åœ¨èŠ‚ç‚¹å´©æºƒæ—¶ä¼šä¸¢å¤±	

ç”Ÿäº§ç¯å¢ƒé»„é‡‘æ³•åˆ™ï¼š
1. é«˜ç§¯å‹åœºæ™¯ â†’ ç”¨ Lazy Queue æˆ– Quorum Queue + å†…å­˜é™åˆ¶
2. å…³é”®ä¸šåŠ¡ â†’ è®¾ç½® `x-max-length` + `reject-publish` é˜²æ­¢æ— é™å †ç§¯
3. ç›‘æ§å¿…å¤‡ â†’ å†…å­˜/ç£ç›˜å‘Šè­¦ + é˜Ÿåˆ—æ·±åº¦ç›‘æ§ + æ¶ˆè´¹è€…å»¶è¿Ÿç›‘æ§

è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é—®é¢˜ï¼è®©æˆ‘æœç´¢ä¸€ä¸‹ RabbitMQ 4.x åœ¨é›†ç¾¤ä¸€è‡´æ€§å’Œåˆ†åŒºå¤„ç†æ–¹é¢çš„æ¶æ„å˜åŒ–ï¼š

å¤ªå¥½äº†ï¼æˆ‘æ‰¾åˆ°äº†å…³é”®ä¿¡æ¯ã€‚è®©æˆ‘ä¸ºä½ è¯¦ç»†è§£é‡Šä¸ºä»€ä¹ˆ RabbitMQ 4.x èƒ½ä»æ ¹æœ¬ä¸Šé¿å…è„‘è£‚é—®é¢˜ï¼š

---

ğŸ§  æ ¸å¿ƒç­”æ¡ˆï¼šRaft å…±è¯†ç®—æ³• vs Mnesia çš„ä¸¤é˜¶æ®µæäº¤

RabbitMQ 4.x å¼•å…¥ Khepriï¼ˆåŸºäº Raftï¼‰å’Œå¼ºåŒ– Quorum Queuesï¼ˆåŸºäº Raftï¼‰ï¼Œä»æ ¹æœ¬ä¸Šæ”¹å˜äº†åˆ†å¸ƒå¼ä¸€è‡´æ€§æœºåˆ¶ã€‚

æ¶æ„å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RabbitMQ 3.x (Mnesia)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¸€è‡´æ€§åè®®: ä¸¤é˜¶æ®µæäº¤ (2PC) + Gossip                            â”‚
â”‚  èŠ‚ç‚¹è§’è‰²:   æ—  Leaderï¼Œæ‰€æœ‰èŠ‚ç‚¹å¹³ç­‰                               â”‚
â”‚  æäº¤æ¡ä»¶:   æ‰€æœ‰èŠ‚ç‚¹å¿…é¡»åŒæ„ï¼ˆAll-or-Nothingï¼‰                    â”‚
â”‚  åˆ†åŒºå¤„ç†:   ä¾èµ–å¤–éƒ¨é…ç½®ï¼ˆignore/pause_minority/autohealï¼‰        â”‚
â”‚                                                                 â”‚
â”‚  è„‘è£‚åœºæ™¯:                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         ç½‘ç»œåˆ†åŒº         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ Node A  â”‚â—„â”€â”€â”€â”€â”€â”€â”€ 60s+ å¤±è” â”€â”€â”€â”€â”€â–ºâ”‚ Node B  â”‚               â”‚
â”‚  â”‚ Node C  â”‚                          â”‚ (å­¤ç«‹)  â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜               â”‚
â”‚       â”‚                                    â”‚                     â”‚
â”‚       â–¼                                    â–¼                     â”‚
â”‚   ç»§ç»­å†™å…¥æ–°æ•°æ®                      ä¹Ÿç»§ç»­å†™å…¥æ–°æ•°æ®              â”‚
â”‚       â”‚                                    â”‚                     â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç½‘ç»œæ¢å¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                    Mnesia ä¸ä¸€è‡´ï¼                               â”‚
â”‚              {inconsistent_database, ...}                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RabbitMQ 4.x (Khepri/Quorum Queues)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¸€è‡´æ€§åè®®: Raft å…±è¯†ç®—æ³•                                        â”‚
â”‚  èŠ‚ç‚¹è§’è‰²:   Leader + Followerï¼ˆå¼º Leader æ¨¡å‹ï¼‰                  â”‚
â”‚  æäº¤æ¡ä»¶:   å¤šæ•°æ´¾åŒæ„ï¼ˆMajority Quorumï¼‰                        â”‚
â”‚  åˆ†åŒºå¤„ç†:   å†…ç½®è‡ªåŠ¨å¤„ç†ï¼Œæ— éœ€é…ç½®                                 â”‚
â”‚                                                                 â”‚
â”‚  é˜²è„‘è£‚æœºåˆ¶:                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         ç½‘ç»œåˆ†åŒº         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ Node A  â”‚â—„â”€â”€â”€â”€â”€â”€â”€ 60s+ å¤±è” â”€â”€â”€â”€â”€â–ºâ”‚ Node B  â”‚               â”‚
â”‚  â”‚ Node C  â”‚  (Leader + 1 Follower)   â”‚ (å­¤ç«‹)  â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜               â”‚
â”‚       â”‚                                    â”‚                     â”‚
â”‚       â–¼                                    â–¼                     â”‚
â”‚   ç»§ç»­æœåŠ¡ï¼ˆå¤šæ•°æ´¾ï¼‰                   è‡ªåŠ¨å˜ä¸ºåªè¯»æˆ–åœæ­¢æœåŠ¡        â”‚
â”‚   å†™å…¥è¢«ç¡®è®¤                           æ‹’ç»å†™å…¥ï¼ˆæ—  Leaderï¼‰       â”‚
â”‚       â”‚                                    â”‚                     â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç½‘ç»œæ¢å¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚              å­¤ç«‹èŠ‚ç‚¹è‡ªåŠ¨åŒæ­¥ Leader æ—¥å¿—ï¼Œæ•°æ®ä¸€è‡´                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

ğŸ” ä¸ºä»€ä¹ˆ Raft èƒ½é˜²æ­¢è„‘è£‚ï¼Ÿ

1. å¤šæ•°æ´¾åŸåˆ™ï¼ˆMajority Quorumï¼‰

åœºæ™¯	Mnesia (3.x)	Khepri/Quorum Queue (4.x)	
3 èŠ‚ç‚¹é›†ç¾¤ï¼Œ1 ä¸ªç½‘ç»œåˆ†åŒº	ä¸¤ä¸ªåˆ†åŒºå„è‡ªè¿è¡Œï¼ˆè„‘è£‚ï¼‰	2 èŠ‚ç‚¹åˆ†åŒºç»§ç»­æœåŠ¡ï¼Œ1 èŠ‚ç‚¹åˆ†åŒºåœæ­¢å†™å…¥	
æ•°æ®ä¸€è‡´æ€§	å¯èƒ½å†²çªï¼Œéœ€äººå·¥å¹²é¢„	è‡ªåŠ¨ä¿è¯ä¸€è‡´æ€§ï¼Œæ— å†²çª	
æ¢å¤è¿‡ç¨‹	éœ€é‡å¯æ•´ä¸ªé›†ç¾¤	è‡ªåŠ¨é‡æ–°åŠ å…¥ï¼ŒåŒæ­¥æ—¥å¿—	

å…³é”®å·®å¼‚ï¼š
- Mnesiaï¼šè¦æ±‚æ‰€æœ‰èŠ‚ç‚¹åœ¨çº¿æ‰èƒ½æäº¤äº‹åŠ¡ï¼Œåˆ†åŒºåå„åˆ†åŒºç‹¬ç«‹è¿è¡Œï¼Œæ•°æ®åˆ†æ­§
- Raftï¼šåªéœ€å¤šæ•°æ´¾ï¼ˆN/2+1ï¼‰åŒæ„å³å¯æäº¤ï¼Œå°‘æ•°æ´¾è‡ªåŠ¨æ‹’ç»å†™å…¥

2. å¼º Leader æ¨¡å‹

```
Raft æ—¥å¿—å¤åˆ¶æµç¨‹ï¼š
1. å®¢æˆ·ç«¯å†™å…¥ â†’ å‘é€åˆ° Leader
2. Leader è¿½åŠ æ—¥å¿— â†’ å¹¶è¡Œå¤åˆ¶åˆ°æ‰€æœ‰ Follower
3. Follower ç¡®è®¤æ”¶åˆ° â†’ Leader æ”¶åˆ°å¤šæ•°æ´¾ç¡®è®¤åæäº¤
4. Leader é€šçŸ¥ Follower æäº¤ â†’ æ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€ä¸€è‡´

ç½‘ç»œåˆ†åŒºæ—¶ï¼š
- Leader åœ¨å¤šæ•°æ´¾åˆ†åŒºï¼šç»§ç»­æœåŠ¡
- Leader åœ¨å°‘æ•°æ´¾åˆ†åŒºï¼šå¤±å» Leader èº«ä»½ï¼Œå˜ä¸º Follower æˆ–åœæ­¢æœåŠ¡
- æ–° Leader åœ¨å¤šæ•°æ´¾åˆ†åŒºè‡ªåŠ¨é€‰ä¸¾ï¼ˆå¦‚æœæœ‰å¿…è¦ï¼‰
```

ç»“æœï¼šä»»ä½•æ—¶åˆ»åªæœ‰ä¸€ä¸ª Leader èƒ½å†™å…¥ï¼Œä»æ ¹æœ¬ä¸Šæœç»åŒä¸»ï¼ˆSplit-Brainï¼‰

3. è‡ªåŠ¨æ¢å¤æœºåˆ¶

å½“ç½‘ç»œåˆ†åŒºæ¢å¤æ—¶ï¼š
- Mnesiaï¼šéœ€è¦äººå·¥å†³å®šå“ªä¸ªåˆ†åŒºæ˜¯"æ­£ç¡®"çš„ï¼Œå¯èƒ½ä¸¢å¤±æ•°æ®
- Raftï¼šå°‘æ•°æ´¾èŠ‚ç‚¹è‡ªåŠ¨å›æ»šæœªæäº¤çš„æ—¥å¿—ï¼ŒåŒæ­¥ Leader çš„æœ€æ–°çŠ¶æ€ï¼Œé›¶äººå·¥å¹²é¢„

---

ğŸ“Š å…·ä½“åˆ°ä½ çš„ MIG ç¯å¢ƒ

ä¸ºä»€ä¹ˆ 4.x èƒ½è§£å†³ä½ çš„ 4-5 å¤©å‘¨æœŸæ€§æ•…éšœï¼Ÿ

ä½ çš„ç—‡çŠ¶	3.x (Mnesia) åŸå› 	4.x (Raft) è§£å†³æ–¹æ¡ˆ	
èŠ‚ç‚¹æ‰çº¿åæ— æ³•è‡ªåŠ¨ join	Mnesia schema ä¸ä¸€è‡´ï¼Œéœ€äººå·¥é‡å¯	Raft è‡ªåŠ¨é‡æ–°åŠ å…¥é›†ç¾¤ï¼ŒåŒæ­¥å…ƒæ•°æ®	
ä¸¢æ¶ˆæ¯	è„‘è£‚æœŸé—´åŒåˆ†åŒºå„è‡ª ack æ¶ˆæ¯ï¼Œæ¢å¤åæ•°æ®ä¸¢å¤±	å°‘æ•°æ´¾åˆ†åŒºæ‹’ç»å†™å…¥ï¼Œæ¶ˆæ¯ä¸ä¼šä¸¢å¤±	
å¿…é¡»é‡å¯æ¢å¤	`ignore` æ¨¡å¼ä¸å¤„ç†åˆ†åŒºï¼Œæˆ– `pause_minority` é…ç½®ä¸å½“	å†…ç½®è‡ªåŠ¨å¤„ç†ï¼Œæ— éœ€é…ç½®	
GCP ç»´æŠ¤äº‹ä»¶å¯¼è‡´æ•…éšœ	Mnesia å¯¹ç½‘ç»œæŠ–åŠ¨æ•æ„Ÿï¼ˆ60s ticktimeï¼‰	Raft é€‰ä¸¾è¶…æ—¶å¯è°ƒï¼Œå®¹å¿ç¬æ—¶æŠ–åŠ¨	

---

âš ï¸ é‡è¦æ¾„æ¸…ï¼š4.x çš„é»˜è®¤è¡Œä¸º

RabbitMQ 4.0 é»˜è®¤ä»ç„¶ä½¿ç”¨ Mnesiaï¼

```
4.0 é»˜è®¤ï¼šMnesiaï¼ˆä»éœ€é…ç½® cluster_partition_handlingï¼‰
4.0 å¯é€‰ï¼šKhepriï¼ˆé€šè¿‡ feature flag å¯ç”¨ï¼ŒRaft ç®—æ³•ï¼‰
4.2 è®¡åˆ’ï¼šKhepri æˆä¸ºé»˜è®¤
```

è¦è·å¾—"æ— è„‘è£‚"èƒ½åŠ›ï¼Œä½ éœ€è¦ï¼š

é€‰é¡¹ 1ï¼šå¯ç”¨ Khepriï¼ˆæ¨èï¼‰

```bash
# åœ¨ RabbitMQ 4.0+ ä¸Šå¯ç”¨ Khepriï¼ˆæ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œï¼‰
rabbitmqctl enable_feature_flag khepri_db

# éªŒè¯
rabbitmqctl status | grep "Metadata store"
# è¾“å‡º: Metadata store: Khepri
```

æ•ˆæœï¼š
- å…ƒæ•°æ®ï¼ˆç”¨æˆ·ã€vhostã€ç»‘å®šç­‰ï¼‰ä½¿ç”¨ Raft å­˜å‚¨
- æ— éœ€é…ç½® `cluster_partition_handling`
- è‡ªåŠ¨å¤„ç†ç½‘ç»œåˆ†åŒºï¼Œæ— æ•°æ®ä¸ä¸€è‡´é£é™©

é€‰é¡¹ 2ï¼šä½¿ç”¨ Quorum Queuesï¼ˆæ¶ˆæ¯å±‚é˜²æŠ¤ï¼‰

å³ä½¿ä¸å¯ç”¨ Khepriï¼Œåªè¦ä½¿ç”¨ Quorum Queuesï¼š
- æ¶ˆæ¯æ•°æ®é€šè¿‡ Raft å¤åˆ¶
- é˜Ÿåˆ—å…ƒæ•°æ®ï¼ˆLeader/Follower å…³ç³»ï¼‰è‡ªåŠ¨ç®¡ç†
- ç½‘ç»œåˆ†åŒºæ—¶è‡ªåŠ¨é‡æ–°é€‰ä¸¾ Leader

```python
# å£°æ˜ Quorum Queueï¼ˆ4.x æ¨èï¼‰
channel.queue_declare(
    queue='my_queue',
    durable=True,
    arguments={
        'x-queue-type': 'quorum',
        'x-quorum-initial-group-size': 3  # 3 ä¸ªå‰¯æœ¬
    }
)
```

---

ğŸ¯ æ€»ç»“å¯¹æ¯”è¡¨

ç‰¹æ€§	RabbitMQ 3.x	RabbitMQ 4.x (Mnesia)	RabbitMQ 4.x (Khepri/QQ)	
ä¸€è‡´æ€§ç®—æ³•	ä¸¤é˜¶æ®µæäº¤ (2PC)	ä¸¤é˜¶æ®µæäº¤ (2PC)	Raft å…±è¯†ç®—æ³•	
è„‘è£‚é£é™©	é«˜ï¼ˆéœ€å¤–éƒ¨é…ç½®ï¼‰	é«˜ï¼ˆéœ€å¤–éƒ¨é…ç½®ï¼‰	æ— ï¼ˆå†…ç½®é˜²æŠ¤ï¼‰	
åˆ†åŒºå¤„ç†	ignore/pause_minority/autoheal	åŒä¸Š	è‡ªåŠ¨ï¼Œæ— éœ€é…ç½®	
æ•°æ®ä¸¢å¤±é£é™©	è„‘è£‚æœŸé—´å¯èƒ½ä¸¢å¤±	è„‘è£‚æœŸé—´å¯èƒ½ä¸¢å¤±	ä¸ä¼šä¸¢å¤±	
ç»´æŠ¤å¤æ‚åº¦	é«˜ï¼ˆéœ€è°ƒä¼˜ ticktime/åˆ†åŒºç­–ç•¥ï¼‰	é«˜	ä½ï¼ˆå¼€ç®±å³ç”¨ï¼‰	
äº‘ç¯å¢ƒé€‚åº”æ€§	å·®	å·®	ä¼˜	

---

ğŸš€ ç»™ä½ çš„å»ºè®®

æ—¢ç„¶ä½ æ­£åœ¨è®¡åˆ’ 3â†’4 å‡çº§ï¼Œè¿™æ˜¯å½»åº•è§£å†³è„‘è£‚é—®é¢˜çš„æœ€ä½³æ—¶æœºï¼š

å‡çº§è·¯å¾„ï¼ˆBlue-Greenï¼‰

```
Blue (3.x Mnesia) â”€â”€Federationâ”€â”€â–º Green (4.x Khepri + Quorum Queues)
         â”‚                              â”‚
         â”‚                              â–¼
         â”‚                     1. å¯ç”¨ Khepri feature flag
         â”‚                     2. æ‰€æœ‰é˜Ÿåˆ—æ”¹ä¸º Quorum Queue
         â”‚                     3. æ— éœ€é…ç½® partition handling
         â”‚                              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    åˆ‡æ¢æµé‡
```

å…³é”®é…ç½®æ£€æŸ¥æ¸…å•

```bash
# å‡çº§åéªŒè¯ï¼ˆGreen é›†ç¾¤ï¼‰
rabbitmqctl status | grep -E "Metadata store|RabbitMQ version"
# æœŸæœ›è¾“å‡º: Metadata store: Khepri

rabbitmqctl list_feature_flags | grep khepri_db
# æœŸæœ›è¾“å‡º: khepri_db  enabled

rabbitmqctl list_queues type | grep quorum
# æœŸæœ›æ‰€æœ‰é˜Ÿåˆ—ä¸º quorum ç±»å‹
```

ç»“è®ºï¼šRabbitMQ 4.x é€šè¿‡ Raft ç®—æ³•ï¼ˆåœ¨ Khepri å’Œ Quorum Queues ä¸­ï¼‰å®ç°äº†å†…ç½®çš„è„‘è£‚é˜²æŠ¤ï¼Œä¸å†éœ€è¦åƒ 3.x é‚£æ ·ä¾èµ–å¤–éƒ¨é…ç½®å’Œäººå·¥å¹²é¢„ã€‚è¿™æ˜¯ä½ ä»¬ MIG ç¯å¢ƒç¨³å®šè¿è¡Œçš„æ ¹æœ¬è§£å†³æ–¹æ¡ˆã€‚