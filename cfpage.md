RabbitMQ 4.0 相比 3.x 版本（特别是 3.13）有几个重大且不兼容的架构变化，主要涉及数据复制机制和核心协议。如果你正在规划升级，这些是必须关注的“硬骨头”。

1. 最重大的变化：经典镜像队列被移除

这是最核心的破坏性变更。RabbitMQ 4.0 彻底移除了“经典镜像队列”（Classic Mirrored Queues）功能。

* 3.x 时代：高可用（HA）主要依赖“经典镜像队列”，通过策略（Policy）设置 
"ha-mode: all" 来复制数据。
* 4.0 时代：“仲裁队列”（Quorum Queues） 成为唯一的官方推荐的高可用队列类型。它基于 Raft 共识算法，数据安全性远高于旧版镜像队列。

⚠️ 升级风险：如果你现有的集群使用了经典镜像队列，升级到 4.0 后，这些队列将自动降级为单副本的非镜像队列，失去高可用性。你必须提前将数据迁移到仲裁队列。

2. 性能与协议：AMQP 1.0 成为核心

AMQP 1.0 协议在 4.0 中从“插件”升级为“核心协议”，性能得到了显著优化。

* 吞吐量翻倍：官方测试显示，AMQP 1.0 在 4.0 中的峰值吞吐量比 3.13 高出两倍以上，甚至在某些场景下略优于 AMQP 0.9.1。
* 内存占用更低：新的实现减少了每个连接的内存开销，集群能支持更多的并发连接。

3. 元数据存储：Khepri 成为正式选项

Khepri 是一个基于 Raft 的新元数据存储引擎，在 3.13 中还是实验性功能，在 4.0 中已成为完全支持的稳定功能。

* 优势：相比旧的 Mnesia，Khepri 在网络分区恢复、删除队列/交换机的效率上表现更好，整体性能更稳定。
* 注意：如果你在 3.13 中启用了 Khepri，无法直接原地升级到 4.0，必须采用蓝绿部署策略。

总结：升级建议

1. 先改队列类型：在升级前，必须将生产环境中的“经典镜像队列”迁移到“仲裁队列”或“流（Streams）”。
2. 检查插件兼容性：确认你使用的第三方插件是否支持 4.0。
3. 利用性能红利：升级后，可以尝试启用 AMQP 1.0 或 Khepri 来获得更好的性能。

